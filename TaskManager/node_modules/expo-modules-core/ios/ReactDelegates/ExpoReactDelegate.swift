// Copyright 2018-present 650 Industries. All rights reserved.

/**
 An extensible react instance creation delegate. This class will loop through each `ExpoReactDelegateHandler` to determine the winner to create the instance.
 */
@objc(EXReactDelegate)
public class ExpoReactDelegate: NSObject {
  private let handlers: [ExpoReactDelegateHandler]

  public init(handlers: [ExpoReactDelegateHandler]) {
    self.handlers = handlers
  }

<<<<<<< HEAD
=======
  #if os(iOS) || os(tvOS)
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
  @objc
  public func createReactRootView(
    moduleName: String,
    initialProperties: [AnyHashable: Any]?,
    launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> UIView {
<<<<<<< HEAD
    return self.handlers
      .compactMap { $0.createReactRootView(reactDelegate: self, moduleName: moduleName, initialProperties: initialProperties, launchOptions: launchOptions) }
      .first(where: { _ in true })
      ?? {
        guard let appDelegate = (UIApplication.shared.delegate as? (any ReactNativeFactoryProvider)) ??
          ((UIApplication.shared.delegate as? NSObject)?.value(forKey: "_expoAppDelegate") as? (any ReactNativeFactoryProvider)) else {
          fatalError("`UIApplication.shared.delegate` must be an `ExpoAppDelegate` or `EXAppDelegateWrapper`")
        }

        return appDelegate.recreateRootView(
=======
    return self.handlers.lazy
      .compactMap { $0.createReactRootView(reactDelegate: self, moduleName: moduleName, initialProperties: initialProperties, launchOptions: launchOptions) }
      .first(where: { _ in true })
      ?? {
        guard let rctAppDelegate = (UIApplication.shared.delegate as? RCTAppDelegate) else {
          fatalError("The `UIApplication.shared.delegate` is not a `RCTAppDelegate` instance.")
        }
        return rctAppDelegate.recreateRootView(
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
          withBundleURL: nil,
          moduleName: moduleName,
          initialProps: initialProperties,
          launchOptions: launchOptions
        )
      }()
  }
<<<<<<< HEAD
=======
  #elseif os(macOS)
  @objc
  public func createReactRootView(
    moduleName: String,
    initialProperties: [AnyHashable: Any]?,
    launchOptions: [AnyHashable: Any]?
  ) -> UIView {
    return UIView()
  }
  #endif
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251

  @objc
  public func bundleURL() -> URL? {
    return self.handlers.lazy
      .compactMap { $0.bundleURL(reactDelegate: self) }
      .first(where: { _ in true })
  }

  @objc
  public func createRootViewController() -> UIViewController {
    return self.handlers.lazy
<<<<<<< HEAD
      .compactMap { $0.createRootViewController() }
=======
      .compactMap { $0.createRootViewController(reactDelegate: self) }
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
      .first(where: { _ in true }) ?? UIViewController()
  }
}
