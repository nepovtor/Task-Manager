package expo.modules.kotlin.types

import com.facebook.react.bridge.Dynamic
import com.facebook.react.bridge.ReadableArray
<<<<<<< HEAD
import expo.modules.kotlin.AppContext
=======
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
import expo.modules.kotlin.exception.CollectionElementCastException
import expo.modules.kotlin.exception.exceptionDecorator
import expo.modules.kotlin.jni.CppType
import expo.modules.kotlin.jni.ExpectedType
import expo.modules.kotlin.jni.SingleType
import expo.modules.kotlin.recycle
import kotlin.reflect.KType

class PairTypeConverter(
  converterProvider: TypeConverterProvider,
  private val pairType: KType
) : DynamicAwareTypeConverters<Pair<*, *>>(pairType.isMarkedNullable) {
  private val converters = listOf(
    converterProvider.obtainTypeConverter(
      requireNotNull(pairType.arguments.getOrNull(0)?.type) {
        "The pair type should contain the type of the first parameter."
      }
    ),
    converterProvider.obtainTypeConverter(
      requireNotNull(pairType.arguments.getOrNull(1)?.type) {
        "The pair type should contain the type of the second parameter."
      }
    )
  )

<<<<<<< HEAD
  override fun convertFromDynamic(value: Dynamic, context: AppContext?): Pair<*, *> {
    val jsArray = value.asArray()
    return convertFromReadableArray(jsArray, context)
  }

  override fun convertFromAny(value: Any, context: AppContext?): Pair<*, *> {
    if (value is ReadableArray) {
      return convertFromReadableArray(value, context)
=======
  override fun convertFromDynamic(value: Dynamic): Pair<*, *> {
    val jsArray = value.asArray()
    return convertFromReadableArray(jsArray)
  }

  override fun convertFromAny(value: Any): Pair<*, *> {
    if (value is ReadableArray) {
      return convertFromReadableArray(value)
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    }

    return value as Pair<*, *>
  }

<<<<<<< HEAD
  private fun convertFromReadableArray(jsArray: ReadableArray, context: AppContext?): Pair<*, *> {
    return Pair(
      convertElement(context, jsArray, 0),
      convertElement(context, jsArray, 1)
    )
  }

  private fun convertElement(context: AppContext?, array: ReadableArray, index: Int): Any? {
=======
  private fun convertFromReadableArray(jsArray: ReadableArray): Pair<*, *> {
    return Pair(
      convertElement(jsArray, 0),
      convertElement(jsArray, 1)
    )
  }

  private fun convertElement(array: ReadableArray, index: Int): Any? {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return array.getDynamic(index).recycle {
      exceptionDecorator({ cause ->
        CollectionElementCastException(pairType, pairType.arguments[index].type!!, type, cause)
      }) {
<<<<<<< HEAD
        converters[index].convert(this, context)
=======
        converters[index].convert(this)
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
      }
    }
  }

  override fun getCppRequiredTypes(): ExpectedType = ExpectedType(
    SingleType(CppType.READABLE_ARRAY)
  )

  override fun isTrivial() = false
}
