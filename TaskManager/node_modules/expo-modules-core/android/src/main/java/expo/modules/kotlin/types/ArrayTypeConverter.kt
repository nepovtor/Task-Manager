package expo.modules.kotlin.types

import com.facebook.react.bridge.Dynamic
<<<<<<< HEAD
import expo.modules.kotlin.AppContext
=======
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
import expo.modules.kotlin.exception.CollectionElementCastException
import expo.modules.kotlin.exception.exceptionDecorator
import expo.modules.kotlin.jni.ExpectedType
import expo.modules.kotlin.recycle
import kotlin.reflect.KClass
import kotlin.reflect.KType

class ArrayTypeConverter(
  converterProvider: TypeConverterProvider,
  private val arrayType: KType
) : DynamicAwareTypeConverters<Array<*>>(arrayType.isMarkedNullable) {
  private val arrayElementConverter = converterProvider.obtainTypeConverter(
    requireNotNull(arrayType.arguments.first().type) {
      "The array type should contain the type of the elements."
    }
  )

<<<<<<< HEAD
  override fun convertFromDynamic(value: Dynamic, context: AppContext?): Array<*> {
=======
  override fun convertFromDynamic(value: Dynamic): Array<*> {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    val jsArray = value.asArray()
    val array = createTypedArray(jsArray.size())
    for (i in 0 until jsArray.size()) {
      array[i] = jsArray
        .getDynamic(i)
        .recycle {
          exceptionDecorator({ cause ->
            CollectionElementCastException(arrayType, arrayType.arguments.first().type!!, type, cause)
          }) {
<<<<<<< HEAD
            arrayElementConverter.convert(this, context)
=======
            arrayElementConverter.convert(this)
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
          }
        }
    }
    return array
  }

<<<<<<< HEAD
  override fun convertFromAny(value: Any, context: AppContext?): Array<*> {
=======
  override fun convertFromAny(value: Any): Array<*> {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return if (arrayElementConverter.isTrivial()) {
      value as Array<*>
    } else {
      (value as Array<*>).map {
        exceptionDecorator({ cause ->
          CollectionElementCastException(
            arrayType,
            arrayType.arguments.first().type!!,
            it!!::class,
            cause
          )
        }) {
<<<<<<< HEAD
          arrayElementConverter.convert(it, context)
=======
          arrayElementConverter.convert(it)
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        }
      }.toTypedArray()
    }
  }

  /**
   * We can't use a Array<Any?> here. We have to create a typed array.
   * Otherwise, cast which is done before calling lambda provided by the user will always fail.
   * For JVM, Array<String> is a different type than Array<Any?>.
   * The first one is translated to `[Ljava.lang.String;` but the second one is translated to `[java.lang.Object;`.
   */
  @Suppress("UNCHECKED_CAST")
  private fun createTypedArray(size: Int): Array<Any?> {
    return java.lang.reflect.Array.newInstance(
      (arrayType.arguments.first().type!!.classifier as KClass<*>).java,
      size
    ) as Array<Any?>
  }

<<<<<<< HEAD
  override fun getCppRequiredTypes(): ExpectedType =
    ExpectedType.forPrimitiveArray(arrayElementConverter.getCppRequiredTypes())
=======
  override fun getCppRequiredTypes(): ExpectedType = ExpectedType.forPrimitiveArray(arrayElementConverter.getCppRequiredTypes())
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251

  override fun isTrivial() = arrayElementConverter.isTrivial()
}
