"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
exports.default = attachKeyHandlers;
<<<<<<< HEAD
var _logger = require("../../utils/logger");
var _OpenDebuggerKeyboardHandler = _interopRequireDefault(
  require("./OpenDebuggerKeyboardHandler")
);
var _chalk = _interopRequireDefault(require("chalk"));
var _execa = _interopRequireDefault(require("execa"));
var _invariant = _interopRequireDefault(require("invariant"));
var _readline = _interopRequireDefault(require("readline"));
var _tty = require("tty");
function _interopRequireDefault(e) {
  return e && e.__esModule ? e : { default: e };
}
const CTRL_C = "\u0003";
const CTRL_D = "\u0004";
const RELOAD_TIMEOUT = 500;
const throttle = (callback, timeout) => {
  let previousCallTimestamp = 0;
  return () => {
    const currentCallTimestamp = new Date().getTime();
    if (currentCallTimestamp - previousCallTimestamp > timeout) {
      previousCallTimestamp = currentCallTimestamp;
      callback();
    }
  };
};
=======
var _KeyPressHandler = require("../../utils/KeyPressHandler");
var _cliTools = require("@react-native-community/cli-tools");
var _chalk = _interopRequireDefault(require("chalk"));
var _execa = _interopRequireDefault(require("execa"));
var _nodeFetch = _interopRequireDefault(require("node-fetch"));
function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}
/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 *
 * @format
 * @oncall react_native
 */

const CTRL_C = "\u0003";
const CTRL_D = "\u0004";
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
function attachKeyHandlers({
  cliConfig,
  devServerUrl,
  messageSocket,
<<<<<<< HEAD
  reporter,
}) {
  if (process.stdin.isTTY !== true) {
    _logger.logger.debug(
=======
  experimentalDebuggerFrontend,
}) {
  if (process.stdin.isTTY !== true) {
    _cliTools.logger.debug(
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
      "Interactive mode is not supported in this environment"
    );
    return;
  }
<<<<<<< HEAD
  _readline.default.emitKeypressEvents(process.stdin);
  setRawMode(true);
=======
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
  const execaOptions = {
    env: {
      FORCE_COLOR: _chalk.default.supportsColor ? "true" : "false",
    },
  };
<<<<<<< HEAD
  const reload = throttle(() => {
    _logger.logger.info("Reloading connected app(s)...");
    messageSocket.broadcast("reload", null);
  }, RELOAD_TIMEOUT);
  const openDebuggerKeyboardHandler = new _OpenDebuggerKeyboardHandler.default({
    reporter,
    devServerUrl,
  });
  process.stdin.on("keypress", (str, key) => {
    _logger.logger.debug(`Key pressed: ${key.sequence}`);
    if (openDebuggerKeyboardHandler.maybeHandleTargetSelection(key.name)) {
      return;
    }
    switch (key.sequence) {
      case "r":
        reload();
        break;
      case "d":
        _logger.logger.info("Opening Dev Menu...");
        messageSocket.broadcast("devMenu", null);
        break;
      case "i":
        _logger.logger.info("Opening app on iOS...");
=======
  const keyPressHandler = new _KeyPressHandler.KeyPressHandler(async (key) => {
    switch (key) {
      case "r":
        _cliTools.logger.info("Reloading connected app(s)...");
        messageSocket.broadcast("reload", null);
        break;
      case "d":
        _cliTools.logger.info("Opening Dev Menu...");
        messageSocket.broadcast("devMenu", null);
        break;
      case "i":
        _cliTools.logger.info("Opening app on iOS...");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        (0, _execa.default)(
          "npx",
          [
            "react-native",
            "run-ios",
            ...(cliConfig.project.ios?.watchModeCommandParams ?? []),
          ],
          execaOptions
        ).stdout?.pipe(process.stdout);
        break;
      case "a":
<<<<<<< HEAD
        _logger.logger.info("Opening app on Android...");
=======
        _cliTools.logger.info("Opening app on Android...");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        (0, _execa.default)(
          "npx",
          [
            "react-native",
            "run-android",
            ...(cliConfig.project.android?.watchModeCommandParams ?? []),
          ],
          execaOptions
        ).stdout?.pipe(process.stdout);
        break;
      case "j":
<<<<<<< HEAD
        void openDebuggerKeyboardHandler.handleOpenDebugger();
        break;
      case CTRL_C:
      case CTRL_D:
        openDebuggerKeyboardHandler.dismiss();
        _logger.logger.info("Stopping server");
        setRawMode(false);
        process.stdin.pause();
=======
        if (!experimentalDebuggerFrontend) {
          return;
        }
        await (0, _nodeFetch.default)(devServerUrl + "/open-debugger", {
          method: "POST",
        });
        break;
      case CTRL_C:
      case CTRL_D:
        _cliTools.logger.info("Stopping server");
        keyPressHandler.stopInterceptingKeyStrokes();
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        process.emit("SIGINT");
        process.exit();
    }
  });
<<<<<<< HEAD
  _logger.logger.log(
=======
  keyPressHandler.createInteractionListener();
  keyPressHandler.startInterceptingKeyStrokes();
  _cliTools.logger.log(
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    [
      "",
      `${_chalk.default.bold("i")} - run on iOS`,
      `${_chalk.default.bold("a")} - run on Android`,
<<<<<<< HEAD
      `${_chalk.default.bold("r")} - reload app`,
      `${_chalk.default.bold("d")} - open Dev Menu`,
      `${_chalk.default.bold("j")} - open DevTools`,
=======
      `${_chalk.default.bold("d")} - open Dev Menu`,
      ...(experimentalDebuggerFrontend
        ? [
            `${_chalk.default.bold(
              "j"
            )} - open debugger (experimental, Hermes only)`,
          ]
        : []),
      `${_chalk.default.bold("r")} - reload app`,
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
      "",
    ].join("\n")
  );
}
<<<<<<< HEAD
function setRawMode(enable) {
  (0, _invariant.default)(
    process.stdin instanceof _tty.ReadStream,
    "process.stdin must be a readable stream to modify raw mode"
  );
  process.stdin.setRawMode(enable);
}
=======
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
