"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
<<<<<<< HEAD
    downloadAndExtractNpmModuleAsync: function() {
        return downloadAndExtractNpmModuleAsync;
    },
    extractLocalNpmTarballAsync: function() {
        return extractLocalNpmTarballAsync;
    },
    extractNpmTarballAsync: function() {
        return extractNpmTarballAsync;
    },
    extractNpmTarballFromUrlAsync: function() {
        return extractNpmTarballFromUrlAsync;
    },
    getNpmUrlAsync: function() {
        return getNpmUrlAsync;
    },
    npmViewAsync: function() {
        return npmViewAsync;
    },
    sanitizeNpmPackageName: function() {
        return sanitizeNpmPackageName;
    }
});
function _spawnasync() {
    const data = /*#__PURE__*/ _interop_require_default(require("@expo/spawn-async"));
    _spawnasync = function() {
=======
    sanitizeNpmPackageName: ()=>sanitizeNpmPackageName,
    npmViewAsync: ()=>npmViewAsync,
    getNpmUrlAsync: ()=>getNpmUrlAsync,
    downloadAndExtractNpmModuleAsync: ()=>downloadAndExtractNpmModuleAsync,
    extractLocalNpmTarballAsync: ()=>extractLocalNpmTarballAsync,
    extractNpmTarballFromUrlAsync: ()=>extractNpmTarballFromUrlAsync,
    extractNpmTarballAsync: ()=>extractNpmTarballAsync
});
function _spawnAsync() {
    const data = /*#__PURE__*/ _interopRequireDefault(require("@expo/spawn-async"));
    _spawnAsync = function() {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        return data;
    };
    return data;
}
function _assert() {
<<<<<<< HEAD
    const data = /*#__PURE__*/ _interop_require_default(require("assert"));
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("assert"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _assert = function() {
        return data;
    };
    return data;
}
function _crypto() {
<<<<<<< HEAD
    const data = /*#__PURE__*/ _interop_require_default(require("crypto"));
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("crypto"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _crypto = function() {
        return data;
    };
    return data;
}
function _fs() {
<<<<<<< HEAD
    const data = /*#__PURE__*/ _interop_require_default(require("fs"));
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("fs"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _fs = function() {
        return data;
    };
    return data;
}
function _slugify() {
<<<<<<< HEAD
    const data = /*#__PURE__*/ _interop_require_default(require("slugify"));
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("slugify"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _slugify = function() {
        return data;
    };
    return data;
}
function _stream() {
    const data = require("stream");
    _stream = function() {
        return data;
    };
    return data;
}
function _tar() {
<<<<<<< HEAD
    const data = require("tar");
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("tar"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _tar = function() {
        return data;
    };
    return data;
}
function _util() {
    const data = require("util");
    _util = function() {
        return data;
    };
    return data;
}
const _createFileTransform = require("./createFileTransform");
const _dir = require("./dir");
const _errors = require("./errors");
const _client = require("../api/rest/client");
<<<<<<< HEAD
function _interop_require_default(obj) {
=======
function _interopRequireDefault(obj) {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
<<<<<<< HEAD
const debug = require('debug')('expo:utils:npm');
const cachedFetch = (0, _client.createCachedFetch)({
    cacheDirectory: 'template-cache'
=======
const debug = require("debug")("expo:utils:npm");
const cachedFetch = (0, _client.createCachedFetch)({
    cacheDirectory: "template-cache"
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
});
function sanitizeNpmPackageName(name) {
    // https://github.com/npm/validate-npm-package-name/#naming-rules
    return applyKnownNpmPackageNameRules(name) || applyKnownNpmPackageNameRules((0, _slugify().default)(name)) || // If nothing is left use 'app' like we do in Xcode projects.
<<<<<<< HEAD
    'app';
=======
    "app";
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}
function applyKnownNpmPackageNameRules(name) {
    // https://github.com/npm/validate-npm-package-name/#naming-rules
    // package name cannot start with '.' or '_'.
    while(/^(\.|_)/.test(name)){
        name = name.substring(1);
    }
<<<<<<< HEAD
    name = name.toLowerCase().replace(/[^a-zA-Z._\-/@]/g, '');
    return name// .replace(/![a-z0-9-._~]+/g, '')
    // Remove special characters
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') || null;
}
async function npmViewAsync(...props) {
    var _stdout;
    const cmd = [
        'view',
        ...props,
        '--json'
    ];
    const results = (_stdout = (await (0, _spawnasync().default)('npm', cmd)).stdout) == null ? void 0 : _stdout.trim();
    const cmdString = `npm ${cmd.join(' ')}`;
    debug('Run:', cmdString);
=======
    name = name.toLowerCase().replace(/[^a-zA-Z._\-/@]/g, "");
    return name// .replace(/![a-z0-9-._~]+/g, '')
    // Remove special characters
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") || null;
}
async function npmViewAsync(...props) {
    var ref;
    const cmd = [
        "view",
        ...props,
        "--json"
    ];
    const results = (ref = (await (0, _spawnAsync().default)("npm", cmd)).stdout) == null ? void 0 : ref.trim();
    const cmdString = `npm ${cmd.join(" ")}`;
    debug("Run:", cmdString);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    if (!results) {
        return null;
    }
    try {
        return JSON.parse(results);
    } catch (error) {
        throw new Error(`Could not parse JSON returned from "${cmdString}".\n\n${results}\n\nError: ${error.message}`);
    }
}
async function getNpmUrlAsync(packageName) {
<<<<<<< HEAD
    const results = await npmViewAsync(packageName, 'dist');
=======
    const results = await npmViewAsync(packageName, "dist");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    (0, _assert().default)(results, `Could not get npm url for package "${packageName}"`);
    // Fully qualified url returns an object.
    // Example:
    // ùù† npm view expo-template-bare-minimum@sdk-33 dist --json
<<<<<<< HEAD
    if (typeof results === 'object' && !Array.isArray(results)) {
=======
    if (typeof results === "object" && !Array.isArray(results)) {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        return results.tarball;
    }
    // When the tag is arbitrary, the tarball is an array, return the last value as it's the most recent.
    // Example:
    // ùù† npm view expo-template-bare-minimum@33 dist --json
    if (Array.isArray(results)) {
        const lastResult = results[results.length - 1];
<<<<<<< HEAD
        if (lastResult && typeof lastResult === 'object' && !Array.isArray(lastResult)) {
            return lastResult.tarball;
        }
    }
    throw new _errors.CommandError('Expected results of `npm view ...` to be an array or string. Instead found: ' + results);
=======
        if (lastResult && typeof lastResult === "object" && !Array.isArray(lastResult)) {
            return lastResult.tarball;
        }
    }
    throw new _errors.CommandError("Expected results of `npm view ...` to be an array or string. Instead found: " + results);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}
// @ts-ignore
const pipeline = (0, _util().promisify)(_stream().Stream.pipeline);
async function downloadAndExtractNpmModuleAsync(npmName, props) {
    const url = await getNpmUrlAsync(npmName);
<<<<<<< HEAD
    debug('Fetch from URL:', url);
=======
    debug("Fetch from URL:", url);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return await extractNpmTarballFromUrlAsync(url, props);
}
async function extractLocalNpmTarballAsync(tarFilePath, props) {
    const readStream = _fs().default.createReadStream(tarFilePath);
    return await extractNpmTarballAsync(readStream, props);
}
async function createUrlStreamAsync(url) {
    const response = await cachedFetch(url);
<<<<<<< HEAD
    if (!response.ok || !response.body) {
        throw new Error(`Unexpected response: ${response.statusText}. From url: ${url}`);
    }
    return _stream().Readable.fromWeb(response.body);
=======
    if (!response.ok) {
        throw new Error(`Unexpected response: ${response.statusText}. From url: ${url}`);
    }
    return response.body;
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}
async function extractNpmTarballFromUrlAsync(url, props) {
    return await extractNpmTarballAsync(await createUrlStreamAsync(url), props);
}
async function extractNpmTarballAsync(stream, props) {
<<<<<<< HEAD
    const { cwd, strip, name, fileList = [], filter } = props;
    await (0, _dir.ensureDirectoryAsync)(cwd);
    const hash = _crypto().default.createHash(props.checksumAlgorithm ?? 'md5');
    const transformStream = new (_stream()).PassThrough();
    transformStream.on('data', (chunk)=>{
        hash.update(chunk);
    });
    await pipeline(stream, transformStream, (0, _tar().extract)({
        cwd,
        filter,
        onentry: (0, _createFileTransform.createEntryResolver)(name),
        strip: strip ?? 1
    }, fileList));
    return hash.digest('hex');
=======
    const { cwd , strip , name , fileList =[] , filter  } = props;
    await (0, _dir.ensureDirectoryAsync)(cwd);
    var _checksumAlgorithm;
    const hash = _crypto().default.createHash((_checksumAlgorithm = props.checksumAlgorithm) != null ? _checksumAlgorithm : "md5");
    const transformStream = new (_stream()).PassThrough();
    transformStream.on("data", (chunk)=>{
        hash.update(chunk);
    });
    await pipeline(stream, transformStream, _tar().default.extract({
        cwd,
        filter,
        onentry: (0, _createFileTransform.createEntryResolver)(name),
        strip: strip != null ? strip : 1
    }, fileList));
    return hash.digest("hex");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}

//# sourceMappingURL=npm.js.map