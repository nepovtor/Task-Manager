"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
<<<<<<< HEAD
    attachAtlasAsync: function() {
        return attachAtlasAsync;
    },
    waitUntilAtlasExportIsReadyAsync: function() {
        return waitUntilAtlasExportIsReadyAsync;
    }
});
const _AtlasPrerequisite = require("./AtlasPrerequisite");
const _env = require("../../../../utils/env");
const debug = require('debug')('expo:metro:debugging:attachAtlas');
async function attachAtlasAsync(options) {
    if (!_env.env.EXPO_ATLAS) {
        return;
    }
    debug('Atlas is enabled, initializing for this project...');
    await new _AtlasPrerequisite.AtlasPrerequisite(options.projectRoot).bootstrapAsync({
=======
    attachAtlasAsync: ()=>attachAtlasAsync,
    waitUntilAtlasExportIsReadyAsync: ()=>waitUntilAtlasExportIsReadyAsync
});
const _atlasPrerequisite = require("./AtlasPrerequisite");
const _env = require("../../../../utils/env");
const debug = require("debug")("expo:metro:debugging:attachAtlas");
async function attachAtlasAsync(options) {
    if (!_env.env.EXPO_UNSTABLE_ATLAS) {
        return;
    }
    debug("Atlas is enabled, initializing for this project...");
    await new _atlasPrerequisite.AtlasPrerequisite(options.projectRoot).bootstrapAsync({
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        exp: options.exp
    });
    return !options.isExporting ? attachAtlasToDevServer(options) : await attachAtlasToExport(options);
}
/**
 * Attach Atlas to the Metro bundler for development mode.
 * This includes attaching to Metro's middleware stack to host the Atlas UI.
 */ function attachAtlasToDevServer(options) {
    if (!options.middleware) {
<<<<<<< HEAD
        throw new Error('Expected middleware to be provided for Atlas when running in development mode');
    }
    const atlas = importAtlasForDev(options.projectRoot);
    if (!atlas) {
        return debug('Atlas is not installed in the project, skipping initialization');
    }
    const instance = atlas.createExpoAtlasMiddleware(options.metroConfig);
    options.middleware.use('/_expo/atlas', instance.middleware);
    debug('Attached Atlas middleware for development on: /_expo/atlas');
=======
        throw new Error("Expected middleware to be provided for Atlas when running in development mode");
    }
    const atlas = importAtlasForDev(options.projectRoot);
    if (!atlas) {
        return debug("Atlas is not installed in the project, skipping initialization");
    }
    const instance = atlas.createExpoAtlasMiddleware(options.metroConfig);
    options.middleware.use("/_expo/atlas", instance.middleware);
    debug("Attached Atlas middleware for development on: /_expo/atlas");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return instance;
}
function importAtlasForDev(projectRoot) {
    try {
<<<<<<< HEAD
        return require(require.resolve('expo-atlas/cli', {
=======
        return require(require.resolve("expo-atlas/cli", {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
            paths: [
                projectRoot
            ]
        }));
    } catch (error) {
<<<<<<< HEAD
        debug('Failed to load Atlas from project:', error);
=======
        debug("Failed to load Atlas from project:", error);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        return null;
    }
}
/**
 * Attach Atlas to the Metro bundler for exporting mode.
 * This only includes attaching the custom serializer to the Metro config.
 */ async function attachAtlasToExport(options) {
    const atlas = importAtlasForExport(options.projectRoot);
    if (!atlas) {
<<<<<<< HEAD
        return debug('Atlas is not installed in the project, skipping initialization');
    }
    if (options.resetAtlasFile) {
        const filePath = await atlas.resetExpoAtlasFile(options.projectRoot);
        debug('(Re)created Atlas file at:', filePath);
    }
    atlas.withExpoAtlas(options.metroConfig);
    debug('Attached Atlas to Metro config for exporting');
}
function importAtlasForExport(projectRoot) {
    try {
        return require(require.resolve('expo-atlas/metro', {
=======
        return debug("Atlas is not installed in the project, skipping initialization");
    }
    if (options.resetAtlasFile) {
        const filePath = await atlas.resetExpoAtlasFile(options.projectRoot);
        debug("(Re)created Atlas file at:", filePath);
    }
    atlas.withExpoAtlas(options.metroConfig);
    debug("Attached Atlas to Metro config for exporting");
}
function importAtlasForExport(projectRoot) {
    try {
        return require(require.resolve("expo-atlas/metro", {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
            paths: [
                projectRoot
            ]
        }));
    } catch (error) {
<<<<<<< HEAD
        debug('Failed to load Atlas from project:', error);
=======
        debug("Failed to load Atlas from project:", error);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        return null;
    }
}
async function waitUntilAtlasExportIsReadyAsync(projectRoot) {
<<<<<<< HEAD
    if (!_env.env.EXPO_ATLAS) return;
    const atlas = importAtlasForExport(projectRoot);
    if (!atlas) {
        return debug('Atlas is not loaded, cannot wait for export to finish');
    }
    if (typeof atlas.waitUntilAtlasFileReady !== 'function') {
        return debug('Atlas is outdated, cannot wait for export to finish');
    }
    debug('Waiting for Atlas to finish exporting...');
    await atlas.waitUntilAtlasFileReady();
    debug('Atlas export is ready');
=======
    if (!_env.env.EXPO_UNSTABLE_ATLAS) return;
    const atlas = importAtlasForExport(projectRoot);
    if (!atlas) {
        return debug("Atlas is not loaded, cannot wait for export to finish");
    }
    if (typeof atlas.waitUntilAtlasFileReady !== "function") {
        return debug("Atlas is outdated, cannot wait for export to finish");
    }
    debug("Waiting for Atlas to finish exporting...");
    await atlas.waitUntilAtlasFileReady();
    debug("Atlas export is ready");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}

//# sourceMappingURL=attachAtlas.js.map