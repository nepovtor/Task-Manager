"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "ServeStaticMiddleware", {
    enumerable: true,
<<<<<<< HEAD
    get: function() {
        return ServeStaticMiddleware;
    }
});
function _path() {
    const data = /*#__PURE__*/ _interop_require_default(require("path"));
=======
    get: ()=>ServeStaticMiddleware
});
function _path() {
    const data = /*#__PURE__*/ _interopRequireDefault(require("path"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _path = function() {
        return data;
    };
    return data;
}
function _send() {
<<<<<<< HEAD
    const data = /*#__PURE__*/ _interop_require_default(require("send"));
=======
    const data = /*#__PURE__*/ _interopRequireDefault(require("send"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _send = function() {
        return data;
    };
    return data;
}
function _url() {
    const data = require("url");
    _url = function() {
        return data;
    };
    return data;
}
const _resolvePlatform = require("./resolvePlatform");
const _env = require("../../../utils/env");
<<<<<<< HEAD
function _interop_require_default(obj) {
=======
function _interopRequireDefault(obj) {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
<<<<<<< HEAD
const debug = require('debug')('expo:start:server:middleware:serveStatic');
=======
const debug = require("debug")("expo:start:server:middleware:serveStatic");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
class ServeStaticMiddleware {
    constructor(projectRoot){
        this.projectRoot = projectRoot;
    }
    getHandler() {
        const publicPath = _path().default.join(this.projectRoot, _env.env.EXPO_PUBLIC_FOLDER);
        debug(`Serving static files from:`, publicPath);
        const opts = {
            root: publicPath
        };
        return (req, res, next)=>{
<<<<<<< HEAD
            if (!(req == null ? void 0 : req.url) || req.method !== 'GET' && req.method !== 'HEAD') {
=======
            if (!(req == null ? void 0 : req.url) || req.method !== "GET" && req.method !== "HEAD") {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
                return next();
            }
            const platform = (0, _resolvePlatform.parsePlatformHeader)(req);
            // Currently this is web-only
<<<<<<< HEAD
            if (platform && platform !== 'web') {
=======
            if (platform && platform !== "web") {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
                return next();
            }
            const pathname = (0, _url().parse)(req.url).pathname;
            if (!pathname) {
                return next();
            }
            debug(`Maybe serve static:`, pathname);
            const stream = (0, _send().default)(req, pathname, opts);
            // add file listener for fallthrough
            let forwardError = false;
<<<<<<< HEAD
            stream.on('file', function onFile() {
=======
            stream.on("file", function onFile() {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
                // once file is determined, always forward error
                forwardError = true;
            });
            // forward errors
<<<<<<< HEAD
            stream.on('error', function error(err) {
=======
            stream.on("error", function error(err) {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
                if (forwardError || !(err.statusCode < 500)) {
                    next(err);
                    return;
                }
                next();
            });
            // pipe
            stream.pipe(res);
        };
    }
}

//# sourceMappingURL=ServeStaticMiddleware.js.map