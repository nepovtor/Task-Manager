<<<<<<< HEAD
{"version":3,"sources":["../../../../../src/start/server/metro/MetroBundlerDevServer.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { ExpoConfig, getConfig } from '@expo/config';\nimport { getMetroServerRoot } from '@expo/config/paths';\nimport * as runtimeEnv from '@expo/env';\nimport { SerialAsset } from '@expo/metro-config/build/serializer/serializerAssets';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport { DeltaResult, TransformInputOptions } from 'metro';\nimport baseJSBundle from 'metro/src/DeltaBundler/Serializers/baseJSBundle';\nimport {\n  sourceMapGeneratorNonBlocking,\n  type SourceMapGeneratorOptions,\n} from 'metro/src/DeltaBundler/Serializers/sourceMapGenerator';\nimport type MetroHmrServer from 'metro/src/HmrServer';\nimport type { Client as MetroHmrClient } from 'metro/src/HmrServer';\nimport { GraphRevision } from 'metro/src/IncrementalBundler';\nimport bundleToString from 'metro/src/lib/bundleToString';\nimport getGraphId from 'metro/src/lib/getGraphId';\nimport { TransformProfile } from 'metro-babel-transformer';\nimport type { CustomResolverOptions } from 'metro-resolver/src/types';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport {\n  createServerComponentsMiddleware,\n  fileURLToFilePath,\n} from './createServerComponentsMiddleware';\nimport { createRouteHandlerMiddleware } from './createServerRouteMiddleware';\nimport { ExpoRouterServerManifestV1, fetchManifest } from './fetchRouterManifest';\nimport { instantiateMetroAsync } from './instantiateMetro';\nimport { getErrorOverlayHtmlAsync, IS_METRO_BUNDLE_ERROR_SYMBOL } from './metroErrorInterface';\nimport { assertMetroPrivateServer, MetroPrivateServer } from './metroPrivateServer';\nimport { metroWatchTypeScriptFiles } from './metroWatchTypeScriptFiles';\nimport {\n  getRouterDirectoryModuleIdWithManifest,\n  hasWarnedAboutApiRoutes,\n  isApiRouteConvention,\n  warnInvalidWebOutput,\n} from './router';\nimport { serializeHtmlWithAssets } from './serializeHtml';\nimport { observeAnyFileChanges, observeFileChanges } from './waitForMetroToObserveTypeScriptFile';\nimport { BundleAssetWithFileHashes, ExportAssetMap } from '../../../export/saveAssets';\nimport { Log } from '../../../log';\nimport { env } from '../../../utils/env';\nimport { CommandError } from '../../../utils/errors';\nimport { toPosixPath } from '../../../utils/filePath';\nimport { getFreePortAsync } from '../../../utils/port';\nimport { BundlerDevServer, BundlerStartOptions, DevServerInstance } from '../BundlerDevServer';\nimport {\n  cachedSourceMaps,\n  evalMetroAndWrapFunctions,\n  evalMetroNoHandling,\n} from '../getStaticRenderFunctions';\nimport { ContextModuleSourceMapsMiddleware } from '../middleware/ContextModuleSourceMapsMiddleware';\nimport { CreateFileMiddleware } from '../middleware/CreateFileMiddleware';\nimport { DevToolsPluginMiddleware } from '../middleware/DevToolsPluginMiddleware';\nimport { createDomComponentsMiddleware } from '../middleware/DomComponentsMiddleware';\nimport { FaviconMiddleware } from '../middleware/FaviconMiddleware';\nimport { HistoryFallbackMiddleware } from '../middleware/HistoryFallbackMiddleware';\nimport { InterstitialPageMiddleware } from '../middleware/InterstitialPageMiddleware';\nimport { resolveMainModuleName } from '../middleware/ManifestMiddleware';\nimport { RuntimeRedirectMiddleware } from '../middleware/RuntimeRedirectMiddleware';\nimport { ServeStaticMiddleware } from '../middleware/ServeStaticMiddleware';\nimport {\n  convertPathToModuleSpecifier,\n  createBundleUrlPath,\n  ExpoMetroOptions,\n  createBundleOsPath,\n  getAsyncRoutesFromExpoConfig,\n  getBaseUrlFromExpoConfig,\n  getMetroDirectBundleOptions,\n  shouldEnableAsyncImports,\n} from '../middleware/metroOptions';\nimport { prependMiddleware } from '../middleware/mutations';\nimport { startTypescriptTypeGenerationAsync } from '../type-generation/startTypescriptTypeGeneration';\n\nexport type ExpoRouterRuntimeManifest = Awaited<\n  ReturnType<typeof import('expo-router/build/static/renderStaticContent').getManifest>\n>;\ntype MetroOnProgress = NonNullable<\n  import('metro/src/DeltaBundler/types').Options<void>['onProgress']\n>;\ntype SSRLoadModuleFunc = <T extends Record<string, any>>(\n  filePath: string,\n  specificOptions?: Partial<ExpoMetroOptions>,\n  extras?: { hot?: boolean }\n) => Promise<T>;\n\ninterface BundleDirectResult {\n  numModifiedFiles: number;\n  lastModifiedDate: Date;\n  nextRevId: string;\n  bundle: string;\n  map: string;\n  /** Defined if the output is multi-bundle. */\n  artifacts?: SerialAsset[];\n  assets?: readonly BundleAssetWithFileHashes[];\n}\n\ninterface MetroModuleContentsResult extends BundleDirectResult {\n  filename: string;\n}\n\ninterface SSRModuleContentsResult extends Omit<BundleDirectResult, 'bundle'> {\n  filename: string;\n  src: string;\n  map: string;\n}\n\nconst debug = require('debug')('expo:start:server:metro') as typeof console.log;\n\n/** Default port to use for apps running in Expo Go. */\nconst EXPO_GO_METRO_PORT = 8081;\n\n/** Default port to use for apps that run in standard React Native projects or Expo Dev Clients. */\nconst DEV_CLIENT_METRO_PORT = 8081;\n\nexport class MetroBundlerDevServer extends BundlerDevServer {\n  private metro: MetroPrivateServer | null = null;\n  private hmrServer: MetroHmrServer | null = null;\n  private ssrHmrClients: Map<string, MetroHmrClient> = new Map();\n  isReactServerComponentsEnabled?: boolean;\n  isReactServerRoutesEnabled?: boolean;\n\n  get name(): string {\n    return 'metro';\n  }\n\n  async resolvePortAsync(options: Partial<BundlerStartOptions> = {}): Promise<number> {\n    const port =\n      // If the manually defined port is busy then an error should be thrown...\n      options.port ??\n      // Otherwise use the default port based on the runtime target.\n      (options.devClient\n        ? // Don't check if the port is busy if we're using the dev client since most clients are hardcoded to 8081.\n          Number(process.env.RCT_METRO_PORT) || DEV_CLIENT_METRO_PORT\n        : // Otherwise (running in Expo Go) use a free port that falls back on the classic 8081 port.\n          await getFreePortAsync(EXPO_GO_METRO_PORT));\n\n    return port;\n  }\n\n  async exportExpoRouterApiRoutesAsync({\n    includeSourceMaps,\n    outputDir,\n    prerenderManifest,\n    platform,\n  }: {\n    includeSourceMaps?: boolean;\n    outputDir: string;\n    // This does not contain the API routes info.\n    prerenderManifest: ExpoRouterServerManifestV1;\n    platform: string;\n  }): Promise<{ files: ExportAssetMap; manifest: ExpoRouterServerManifestV1<string> }> {\n    const { routerRoot } = this.instanceMetroOptions;\n    assert(\n      routerRoot != null,\n      'The server must be started before calling exportExpoRouterApiRoutesAsync.'\n    );\n\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const manifest = await this.getExpoRouterRoutesManifestAsync({ appDir });\n\n    const files: ExportAssetMap = new Map();\n\n    // Inject RSC middleware.\n    const rscPath = '/_flight/[...rsc]';\n\n    if (\n      this.isReactServerComponentsEnabled &&\n      // If the RSC route is not already in the manifest, add it.\n      !manifest.apiRoutes.find((route) => route.page.startsWith('/_flight/'))\n    ) {\n      debug('Adding RSC route to the manifest:', rscPath);\n      // NOTE: This might need to be sorted to the correct spot in the future.\n      manifest.apiRoutes.push({\n        file: resolveFrom(this.projectRoot, '@expo/cli/static/template/[...rsc]+api.ts'),\n        page: rscPath,\n        namedRegex: '^/_flight(?:/(?<rsc>.+?))?(?:/)?$',\n        routeKeys: { rsc: 'rsc' },\n      });\n    }\n\n    for (const route of manifest.apiRoutes) {\n      const filepath = path.isAbsolute(route.file) ? route.file : path.join(appDir, route.file);\n      const contents = await this.bundleApiRoute(filepath, { platform });\n\n      const artifactFilename =\n        route.page === rscPath\n          ? // HACK: Add RSC renderer to the output...\n            convertPathToModuleSpecifier(path.join(outputDir, '.' + rscPath + '.js'))\n          : convertPathToModuleSpecifier(\n              path.join(outputDir, path.relative(appDir, filepath.replace(/\\.[tj]sx?$/, '.js')))\n            );\n\n      if (contents) {\n        let src = contents.src;\n\n        if (includeSourceMaps && contents.map) {\n          // TODO(kitten): Merge the source map transformer in the future\n          // https://github.com/expo/expo/blob/0dffdb15/packages/%40expo/metro-config/src/serializer/serializeChunks.ts#L422-L439\n          // Alternatively, check whether `sourcesRoot` helps here\n          const artifactBasename = encodeURIComponent(path.basename(artifactFilename) + '.map');\n          src = src.replace(\n            /\\/\\/# sourceMappingURL=.*/g,\n            `//# sourceMappingURL=${artifactBasename}`\n          );\n\n          const parsedMap =\n            typeof contents.map === 'string' ? JSON.parse(contents.map) : contents.map;\n          files.set(artifactFilename + '.map', {\n            contents: JSON.stringify({\n              version: parsedMap.version,\n              sources: parsedMap.sources.map((source: string) => {\n                source =\n                  typeof source === 'string' && source.startsWith(this.projectRoot)\n                    ? path.relative(this.projectRoot, source)\n                    : source;\n                return convertPathToModuleSpecifier(source);\n              }),\n              sourcesContent: new Array(parsedMap.sources.length).fill(null),\n              names: parsedMap.names,\n              mappings: parsedMap.mappings,\n            }),\n            apiRouteId: route.page,\n            targetDomain: 'server',\n          });\n        }\n        files.set(artifactFilename, {\n          contents: src,\n          apiRouteId: route.page,\n          targetDomain: 'server',\n        });\n      }\n      // Remap the manifest files to represent the output files.\n      route.file = artifactFilename;\n    }\n\n    return {\n      manifest: {\n        ...manifest,\n        htmlRoutes: prerenderManifest.htmlRoutes,\n      },\n      files,\n    };\n  }\n\n  async getExpoRouterRoutesManifestAsync({ appDir }: { appDir: string }) {\n    // getBuiltTimeServerManifest\n    const { exp } = getConfig(this.projectRoot);\n    const manifest = await fetchManifest(this.projectRoot, {\n      ...exp.extra?.router,\n      preserveRedirectAndRewrites: true,\n      asJson: true,\n      appDir,\n    });\n\n    if (!manifest) {\n      throw new CommandError(\n        'EXPO_ROUTER_SERVER_MANIFEST',\n        'Unexpected error: server manifest could not be fetched.'\n      );\n    }\n\n    return manifest;\n  }\n\n  async getServerManifestAsync(): Promise<{\n    serverManifest: ExpoRouterServerManifestV1;\n    htmlManifest: ExpoRouterRuntimeManifest;\n  }> {\n    const { exp } = getConfig(this.projectRoot);\n    // NOTE: This could probably be folded back into `renderStaticContent` when expo-asset and font support RSC.\n    const { getBuildTimeServerManifestAsync, getManifest } = await this.ssrLoadModule<\n      typeof import('expo-router/build/static/getServerManifest')\n    >('expo-router/build/static/getServerManifest.js', {\n      // Only use react-server environment when the routes are using react-server rendering by default.\n      environment: this.isReactServerRoutesEnabled ? 'react-server' : 'node',\n    });\n\n    return {\n      serverManifest: await getBuildTimeServerManifestAsync({ ...exp.extra?.router }),\n      htmlManifest: await getManifest({ ...exp.extra?.router }),\n    };\n  }\n\n  async getStaticRenderFunctionAsync(): Promise<{\n    serverManifest: ExpoRouterServerManifestV1;\n    manifest: ExpoRouterRuntimeManifest;\n    renderAsync: (path: string) => Promise<string>;\n  }> {\n    const url = this.getDevServerUrlOrAssert();\n\n    const { getStaticContent, getManifest, getBuildTimeServerManifestAsync } =\n      await this.ssrLoadModule<typeof import('expo-router/build/static/renderStaticContent')>(\n        'expo-router/node/render.js',\n        {\n          // This must always use the legacy rendering resolution (no `react-server`) because it leverages\n          // the previous React SSG utilities which aren't available in React 19.\n          environment: 'node',\n        }\n      );\n\n    const { exp } = getConfig(this.projectRoot);\n\n    return {\n      serverManifest: await getBuildTimeServerManifestAsync({\n        ...exp.extra?.router,\n      }),\n      // Get routes from Expo Router.\n      manifest: await getManifest({ preserveApiRoutes: false, ...exp.extra?.router }),\n      // Get route generating function\n      async renderAsync(path: string) {\n        return await getStaticContent(new URL(path, url));\n      },\n    };\n  }\n\n  async getStaticResourcesAsync({\n    includeSourceMaps,\n    mainModuleName,\n    clientBoundaries = this.instanceMetroOptions.clientBoundaries ?? [],\n    platform = 'web',\n  }: {\n    includeSourceMaps?: boolean;\n    mainModuleName?: string;\n    clientBoundaries?: string[];\n    platform?: string;\n  } = {}) {\n    const { mode, minify, isExporting, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        routerRoot != null &&\n        reactCompiler != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticResourcesAsync.'\n    );\n\n    const resolvedMainModuleName =\n      mainModuleName ?? './' + resolveMainModuleName(this.projectRoot, { platform });\n    return await this.metroImportAsArtifactsAsync(resolvedMainModuleName, {\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      minify,\n      environment: 'client',\n      serializerIncludeMaps: includeSourceMaps,\n      mainModuleName: resolvedMainModuleName,\n      lazy: shouldEnableAsyncImports(this.projectRoot),\n      asyncRoutes,\n      baseUrl,\n      isExporting,\n      routerRoot,\n      clientBoundaries,\n      reactCompiler,\n      bytecode: false,\n    });\n  }\n\n  private async getStaticPageAsync(pathname: string) {\n    const { mode, isExporting, clientBoundaries, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        reactCompiler != null &&\n        routerRoot != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticPageAsync.'\n    );\n    const platform = 'web';\n\n    const devBundleUrlPathname = createBundleUrlPath({\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      environment: 'client',\n      reactCompiler,\n      mainModuleName: resolveMainModuleName(this.projectRoot, { platform }),\n      lazy: shouldEnableAsyncImports(this.projectRoot),\n      baseUrl,\n      isExporting,\n      asyncRoutes,\n      routerRoot,\n      clientBoundaries,\n      bytecode: false,\n    });\n\n    const bundleStaticHtml = async (): Promise<string> => {\n      const { getStaticContent } = await this.ssrLoadModule<\n        typeof import('expo-router/build/static/renderStaticContent')\n      >('expo-router/node/render.js', {\n        // This must always use the legacy rendering resolution (no `react-server`) because it leverages\n        // the previous React SSG utilities which aren't available in React 19.\n        environment: 'node',\n        minify: false,\n        isExporting,\n        platform,\n      });\n\n      const location = new URL(pathname, this.getDevServerUrlOrAssert());\n      return await getStaticContent(location);\n    };\n\n    const [{ artifacts: resources }, staticHtml] = await Promise.all([\n      this.getStaticResourcesAsync({\n        clientBoundaries: [],\n      }),\n      bundleStaticHtml(),\n    ]);\n    const content = serializeHtmlWithAssets({\n      isExporting,\n      resources,\n      template: staticHtml,\n      devBundleUrl: devBundleUrlPathname,\n      baseUrl,\n      hydrate: env.EXPO_WEB_DEV_HYDRATE,\n    });\n    return {\n      content,\n      resources,\n    };\n  }\n\n  // Set when the server is started.\n  private instanceMetroOptions: Partial<ExpoMetroOptions> = {};\n\n  private ssrLoadModule: SSRLoadModuleFunc = async (\n    filePath,\n    specificOptions = {},\n    extras = {}\n  ) => {\n    const res = await this.ssrLoadModuleContents(filePath, specificOptions);\n\n    if (\n      // TODO: hot should be a callback function for invalidating the related SSR module.\n      extras.hot &&\n      this.instanceMetroOptions.isExporting !== true\n    ) {\n      // Register SSR HMR\n      const serverRoot = getMetroServerRoot(this.projectRoot);\n      const relativePath = path.relative(serverRoot, res.filename);\n      const url = new URL(relativePath, this.getDevServerUrlOrAssert());\n      this.setupHmr(url);\n    }\n\n    return evalMetroAndWrapFunctions(\n      this.projectRoot,\n      res.src,\n      res.filename,\n      specificOptions.isExporting ?? this.instanceMetroOptions.isExporting!\n    );\n  };\n\n  private async metroImportAsArtifactsAsync(\n    filePath: string,\n    specificOptions: Partial<Omit<ExpoMetroOptions, 'serializerOutput'>> = {}\n  ) {\n    const results = await this.ssrLoadModuleContents(filePath, {\n      serializerOutput: 'static',\n      ...specificOptions,\n    });\n\n    // NOTE: This could potentially need more validation in the future.\n    if (results.artifacts && results.assets) {\n      return {\n        artifacts: results.artifacts,\n        assets: results.assets,\n        src: results.src,\n        filename: results.filename,\n        map: results.map,\n      };\n    }\n    throw new CommandError('Invalid bundler results: ' + results);\n  }\n\n  private async metroLoadModuleContents(\n    filePath: string,\n    specificOptions: ExpoMetroOptions,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<MetroModuleContentsResult> {\n    const { baseUrl } = this.instanceMetroOptions;\n    assert(baseUrl != null, 'The server must be started before calling metroLoadModuleContents.');\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      // mainModuleName: filePath,\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      // bytecode: false,\n      // Bundle in Node.js mode for SSR.\n      environment: 'node',\n      // platform: 'web',\n      // mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n      baseUrl,\n      // routerRoot,\n      // isExporting,\n      ...specificOptions,\n    };\n\n    const expoBundleOptions = getMetroDirectBundleOptions(opts);\n\n    const resolverOptions = {\n      customResolverOptions: expoBundleOptions.customResolverOptions ?? {},\n      dev: expoBundleOptions.dev ?? true,\n    };\n\n    const transformOptions: TransformInputOptions = {\n      dev: expoBundleOptions.dev ?? true,\n      hot: true,\n      minify: expoBundleOptions.minify ?? false,\n      type: 'module',\n      unstable_transformProfile:\n        extraOptions.unstable_transformProfile ??\n        expoBundleOptions.unstable_transformProfile ??\n        'default',\n      customTransformOptions: expoBundleOptions.customTransformOptions ?? Object.create(null),\n      platform: expoBundleOptions.platform ?? 'web',\n      // @ts-expect-error: `runtimeBytecodeVersion` does not exist in `expoBundleOptions` or `TransformInputOptions`\n      runtimeBytecodeVersion: expoBundleOptions.runtimeBytecodeVersion,\n    };\n\n    const resolvedEntryFilePath = await this.resolveRelativePathAsync(filePath, {\n      resolverOptions,\n      transformOptions,\n    });\n\n    const filename = createBundleOsPath({\n      ...opts,\n      mainModuleName: resolvedEntryFilePath,\n    });\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    const results = await this._bundleDirectAsync(resolvedEntryFilePath, {\n      graphOptions: {\n        lazy: expoBundleOptions.lazy ?? false,\n        shallow: expoBundleOptions.shallow ?? false,\n      },\n      resolverOptions,\n      serializerOptions: {\n        ...expoBundleOptions.serializerOptions,\n\n        inlineSourceMap: expoBundleOptions.inlineSourceMap ?? false,\n        modulesOnly: expoBundleOptions.modulesOnly ?? false,\n        runModule: expoBundleOptions.runModule ?? true,\n        // @ts-expect-error\n        sourceUrl: expoBundleOptions.sourceUrl,\n        // @ts-expect-error\n        sourceMapUrl: extraOptions.sourceMapUrl ?? expoBundleOptions.sourceMapUrl,\n      },\n      transformOptions,\n    });\n\n    return {\n      ...results,\n      filename,\n    };\n  }\n\n  private async ssrLoadModuleContents(\n    filePath: string,\n    specificOptions: Partial<ExpoMetroOptions> = {}\n  ): Promise<SSRModuleContentsResult> {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling ssrLoadModuleContents.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      mainModuleName: convertPathToModuleSpecifier(filePath),\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      bytecode: false,\n      // Bundle in Node.js mode for SSR unless RSC is enabled.\n      environment: this.isReactServerComponentsEnabled ? 'react-server' : 'node',\n      platform: 'web',\n      mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n\n      // Mostly disable compiler in SSR bundles.\n      reactCompiler: false,\n      baseUrl,\n      routerRoot,\n      isExporting,\n\n      ...specificOptions,\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    const { filename, bundle, map, ...rest } = await this.metroLoadModuleContents(filePath, opts);\n    const scriptContents = wrapBundle(bundle);\n\n    if (map) {\n      debug('Registering SSR source map for:', filename);\n      cachedSourceMaps.set(filename, { url: this.projectRoot, map });\n    } else {\n      debug('No SSR source map found for:', filename);\n    }\n\n    return {\n      ...rest,\n      src: scriptContents,\n      filename,\n      map,\n    };\n  }\n\n  async nativeExportBundleAsync(\n    exp: ExpoConfig,\n    options: Omit<\n      ExpoMetroOptions,\n      'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    files: ExportAssetMap,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{\n    artifacts: SerialAsset[];\n    assets: readonly BundleAssetWithFileHashes[];\n    files?: ExportAssetMap;\n  }> {\n    if (this.isReactServerComponentsEnabled) {\n      return this.singlePageReactServerComponentExportAsync(exp, options, files, extraOptions);\n    }\n\n    return this.legacySinglePageExportBundleAsync(options, extraOptions);\n  }\n\n  private async singlePageReactServerComponentExportAsync(\n    exp: ExpoConfig,\n    options: Omit<\n      ExpoMetroOptions,\n      'baseUrl' | 'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    files: ExportAssetMap,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{\n    artifacts: SerialAsset[];\n    assets: readonly BundleAssetWithFileHashes[];\n    files: ExportAssetMap;\n  }> {\n    const getReactServerReferences = (artifacts: SerialAsset[]): string[] => {\n      // Get the React server action boundaries from the client bundle.\n      return unique(\n        artifacts\n          .filter((a) => a.type === 'js')\n          .map((artifact) =>\n            artifact.metadata.reactServerReferences?.map((ref) => fileURLToFilePath(ref))\n          )\n          // TODO: Segment by module for splitting.\n          .flat()\n          .filter(Boolean) as string[]\n      );\n    };\n\n    // NOTE(EvanBacon): This will not support any code elimination since it's a static pass.\n    let {\n      reactClientReferences: clientBoundaries,\n      reactServerReferences: serverActionReferencesInServer,\n      cssModules,\n    } = await this.rscRenderer!.getExpoRouterClientReferencesAsync(\n      {\n        platform: options.platform,\n        domRoot: options.domRoot,\n      },\n      files\n    );\n\n    // TODO: The output keys should be in production format or use a lookup manifest.\n\n    const processClientBoundaries = async (\n      reactServerReferences: string[]\n    ): Promise<{\n      artifacts: SerialAsset[];\n      assets: readonly BundleAssetWithFileHashes[];\n    }> => {\n      debug('Evaluated client boundaries:', clientBoundaries);\n\n      // Run metro bundler and create the JS bundles/source maps.\n      const bundle = await this.legacySinglePageExportBundleAsync(\n        {\n          ...options,\n          clientBoundaries,\n        },\n        extraOptions\n      );\n\n      // Get the React server action boundaries from the client bundle.\n      const newReactServerReferences = getReactServerReferences(bundle.artifacts);\n\n      if (!newReactServerReferences) {\n        // Possible issue with babel plugin / metro-config.\n        throw new Error(\n          'Static server action references were not returned from the Metro client bundle'\n        );\n      }\n      debug('React server action boundaries from client:', newReactServerReferences);\n\n      const allKnownReactServerReferences = unique([\n        ...reactServerReferences,\n        ...newReactServerReferences,\n      ]);\n\n      // When we export the server actions that were imported from the client, we may need to re-bundle the client with the new client boundaries.\n      const { clientBoundaries: nestedClientBoundaries } =\n        await this.rscRenderer!.exportServerActionsAsync(\n          {\n            platform: options.platform,\n            domRoot: options.domRoot,\n            entryPoints: allKnownReactServerReferences,\n          },\n          files\n        );\n\n      // TODO: Check against all modules in the initial client bundles.\n      const hasUniqueClientBoundaries = nestedClientBoundaries.some(\n        (boundary) => !clientBoundaries.includes(boundary)\n      );\n\n      if (!hasUniqueClientBoundaries) {\n        return bundle;\n      }\n\n      debug('Re-bundling client with nested client boundaries:', nestedClientBoundaries);\n\n      clientBoundaries = unique(clientBoundaries.concat(nestedClientBoundaries));\n\n      // Re-bundle the client with the new client boundaries that only exist in server actions that were imported from the client.\n      // Run metro bundler and create the JS bundles/source maps.\n      return processClientBoundaries(allKnownReactServerReferences);\n    };\n\n    const bundle = await processClientBoundaries(serverActionReferencesInServer);\n\n    // Inject the global CSS that was imported during the server render.\n    bundle.artifacts.push(...cssModules);\n\n    const serverRoot = getMetroServerRoot(this.projectRoot);\n\n    // HACK: Maybe this should be done in the serializer.\n    const clientBoundariesAsOpaqueIds = clientBoundaries.map((boundary) =>\n      // NOTE(cedric): relative module specifiers / IDs should always be POSIX formatted\n      toPosixPath(path.relative(serverRoot, boundary))\n    );\n    const moduleIdToSplitBundle = (\n      bundle.artifacts\n        .map((artifact) => artifact?.metadata?.paths && Object.values(artifact.metadata.paths))\n        .filter(Boolean)\n        .flat() as Record<string, string>[]\n    ).reduce((acc, paths) => ({ ...acc, ...paths }), {});\n\n    debug('SSR Manifest:', moduleIdToSplitBundle, clientBoundariesAsOpaqueIds);\n\n    const ssrManifest = new Map<string, string>();\n\n    if (Object.keys(moduleIdToSplitBundle).length) {\n      clientBoundariesAsOpaqueIds.forEach((boundary) => {\n        if (boundary in moduleIdToSplitBundle) {\n          ssrManifest.set(boundary, moduleIdToSplitBundle[boundary]);\n        } else {\n          throw new Error(\n            `Could not find boundary \"${boundary}\" in the SSR manifest. Available: ${Object.keys(moduleIdToSplitBundle).join(', ')}`\n          );\n        }\n      });\n    } else {\n      // Native apps with bundle splitting disabled.\n      debug('No split bundles');\n      clientBoundariesAsOpaqueIds.forEach((boundary) => {\n        // @ts-expect-error\n        ssrManifest.set(boundary, null);\n      });\n    }\n\n    const routerOptions = exp.extra?.router;\n\n    // Export the static RSC files\n    await this.rscRenderer!.exportRoutesAsync(\n      {\n        platform: options.platform,\n        ssrManifest,\n        routerOptions,\n      },\n      files\n    );\n\n    // Save the SSR manifest so we can perform more replacements in the server renderer and with server actions.\n    files.set(`_expo/rsc/${options.platform}/ssr-manifest.js`, {\n      targetDomain: 'server',\n      contents:\n        'module.exports = ' +\n        JSON.stringify(\n          // TODO: Add a less leaky version of this across the framework with just [key, value] (module ID, chunk).\n          Object.fromEntries(\n            Array.from(ssrManifest.entries()).map(([key, value]) => [\n              // Must match babel plugin.\n              './' + toPosixPath(path.relative(this.projectRoot, path.join(serverRoot, key))),\n              [key, value],\n            ])\n          )\n        ),\n    });\n\n    return { ...bundle, files };\n  }\n\n  async legacySinglePageExportBundleAsync(\n    options: Omit<\n      ExpoMetroOptions,\n      'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{ artifacts: SerialAsset[]; assets: readonly BundleAssetWithFileHashes[] }> {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(options.mainModuleName != null, 'mainModuleName must be provided in options.');\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling legacySinglePageExportBundleAsync.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      ...this.instanceMetroOptions,\n      baseUrl,\n      routerRoot,\n      isExporting,\n      ...options,\n      environment: 'client',\n      serializerOutput: 'static',\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    if (!opts.mainModuleName.startsWith('/') && !path.isAbsolute(opts.mainModuleName)) {\n      opts.mainModuleName = './' + opts.mainModuleName;\n    }\n\n    const output = await this.metroLoadModuleContents(opts.mainModuleName, opts, extraOptions);\n\n    return {\n      artifacts: output.artifacts!,\n      assets: output.assets!,\n    };\n  }\n\n  async watchEnvironmentVariables() {\n    if (!this.instance) {\n      throw new Error(\n        'Cannot observe environment variable changes without a running Metro instance.'\n      );\n    }\n    if (!this.metro) {\n      // This can happen when the run command is used and the server is already running in another\n      // process.\n      debug('Skipping Environment Variable observation because Metro is not running (headless).');\n      return;\n    }\n\n    const envFiles = runtimeEnv\n      .getFiles(process.env.NODE_ENV)\n      .map((fileName) => path.join(this.projectRoot, fileName));\n\n    observeFileChanges(\n      {\n        metro: this.metro,\n        server: this.instance.server,\n      },\n      envFiles,\n      () => {\n        debug('Reloading environment variables...');\n        // Force reload the environment variables.\n        runtimeEnv.load(this.projectRoot, { force: true });\n      }\n    );\n  }\n\n  rscRenderer: Awaited<ReturnType<typeof createServerComponentsMiddleware>> | null = null;\n\n  protected async startImplementationAsync(\n    options: BundlerStartOptions\n  ): Promise<DevServerInstance> {\n    options.port = await this.resolvePortAsync(options);\n    this.urlCreator = this.getUrlCreator(options);\n\n    const config = getConfig(this.projectRoot, { skipSDKVersionRequirement: true });\n    const { exp } = config;\n    // NOTE: This will change in the future when it's less experimental, we enable React 19, and turn on more RSC flags by default.\n    const isReactServerComponentsEnabled =\n      !!exp.experiments?.reactServerComponentRoutes || !!exp.experiments?.reactServerFunctions;\n    const isReactServerActionsOnlyEnabled =\n      !exp.experiments?.reactServerComponentRoutes && !!exp.experiments?.reactServerFunctions;\n    this.isReactServerComponentsEnabled = isReactServerComponentsEnabled;\n    this.isReactServerRoutesEnabled = !!exp.experiments?.reactServerComponentRoutes;\n\n    const useServerRendering = ['static', 'server'].includes(exp.web?.output ?? '');\n    const hasApiRoutes = isReactServerComponentsEnabled || exp.web?.output === 'server';\n    const baseUrl = getBaseUrlFromExpoConfig(exp);\n    const asyncRoutes = getAsyncRoutesFromExpoConfig(exp, options.mode ?? 'development', 'web');\n    const routerRoot = getRouterDirectoryModuleIdWithManifest(this.projectRoot, exp);\n    const reactCompiler = !!exp.experiments?.reactCompiler;\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const mode = options.mode ?? 'development';\n\n    const routerOptions = exp.extra?.router;\n\n    if (isReactServerComponentsEnabled && exp.web?.output === 'static') {\n      throw new CommandError(\n        `Experimental server component support does not support 'web.output: ${exp.web!.output}' yet. Use 'web.output: \"server\"' during the experimental phase.`\n      );\n    }\n\n    // Error early about the window.location polyfill when React Server Components are enabled.\n    if (isReactServerComponentsEnabled && exp?.extra?.router?.origin === false) {\n      const configPath = config.dynamicConfigPath ?? config.staticConfigPath ?? '/app.json';\n      const configFileName = path.basename(configPath);\n      throw new CommandError(\n        `The Expo Router \"origin\" property in the Expo config (${configFileName}) cannot be \"false\" when React Server Components is enabled. Remove it from the ${configFileName} file and try again.`\n      );\n    }\n\n    const instanceMetroOptions = {\n      isExporting: !!options.isExporting,\n      baseUrl,\n      mode,\n      routerRoot,\n      reactCompiler,\n      minify: options.minify,\n      asyncRoutes,\n      // Options that are changing between platforms like engine, platform, and environment aren't set here.\n    };\n    this.instanceMetroOptions = instanceMetroOptions;\n\n    const parsedOptions = {\n      port: options.port,\n      maxWorkers: options.maxWorkers,\n      resetCache: options.resetDevServer,\n    };\n\n    // Required for symbolication:\n    process.env.EXPO_DEV_SERVER_ORIGIN = `http://localhost:${options.port}`;\n\n    const { metro, hmrServer, server, middleware, messageSocket } = await instantiateMetroAsync(\n      this,\n      parsedOptions,\n      {\n        isExporting: !!options.isExporting,\n        exp,\n      }\n    );\n\n    if (!options.isExporting) {\n      const manifestMiddleware = await this.getManifestMiddlewareAsync(options);\n\n      // Important that we noop source maps for context modules as soon as possible.\n      prependMiddleware(middleware, new ContextModuleSourceMapsMiddleware().getHandler());\n\n      // We need the manifest handler to be the first middleware to run so our\n      // routes take precedence over static files. For example, the manifest is\n      // served from '/' and if the user has an index.html file in their project\n      // then the manifest handler will never run, the static middleware will run\n      // and serve index.html instead of the manifest.\n      // https://github.com/expo/expo/issues/13114\n      prependMiddleware(middleware, manifestMiddleware.getHandler());\n\n      middleware.use(\n        new InterstitialPageMiddleware(this.projectRoot, {\n          // TODO: Prevent this from becoming stale.\n          scheme: options.location.scheme ?? null,\n        }).getHandler()\n      );\n      middleware.use(\n        new DevToolsPluginMiddleware(this.projectRoot, this.devToolsPluginManager).getHandler()\n      );\n\n      const deepLinkMiddleware = new RuntimeRedirectMiddleware(this.projectRoot, {\n        getLocation: ({ runtime }) => {\n          if (runtime === 'custom') {\n            return this.urlCreator?.constructDevClientUrl();\n          } else {\n            return this.urlCreator?.constructUrl({\n              scheme: 'exp',\n            });\n          }\n        },\n      });\n      middleware.use(deepLinkMiddleware.getHandler());\n\n      const serverRoot = getMetroServerRoot(this.projectRoot);\n\n      const domComponentRenderer = createDomComponentsMiddleware(\n        {\n          metroRoot: serverRoot,\n          projectRoot: this.projectRoot,\n        },\n        instanceMetroOptions\n      );\n      // Add support for DOM components.\n      // TODO: Maybe put behind a flag for now?\n      middleware.use(domComponentRenderer);\n\n      middleware.use(new CreateFileMiddleware(this.projectRoot).getHandler());\n\n      // Append support for redirecting unhandled requests to the index.html page on web.\n      if (this.isTargetingWeb()) {\n        // This MUST be after the manifest middleware so it doesn't have a chance to serve the template `public/index.html`.\n        middleware.use(new ServeStaticMiddleware(this.projectRoot).getHandler());\n\n        // This should come after the static middleware so it doesn't serve the favicon from `public/favicon.ico`.\n        middleware.use(new FaviconMiddleware(this.projectRoot).getHandler());\n      }\n\n      if (useServerRendering || isReactServerComponentsEnabled) {\n        observeAnyFileChanges(\n          {\n            metro,\n            server,\n          },\n          (events) => {\n            if (hasApiRoutes) {\n              // NOTE(EvanBacon): We aren't sure what files the API routes are using so we'll just invalidate\n              // aggressively to ensure we always have the latest. The only caching we really get here is for\n              // cases where the user is making subsequent requests to the same API route without changing anything.\n              // This is useful for testing but pretty suboptimal. Luckily our caching is pretty aggressive so it makes\n              // up for a lot of the overhead.\n              this.invalidateApiRouteCache();\n            } else if (!hasWarnedAboutApiRoutes()) {\n              for (const event of events) {\n                if (\n                  // If the user did not delete a file that matches the Expo Router API Route convention, then we should warn that\n                  // API Routes are not enabled in the project.\n                  event.metadata?.type !== 'd' &&\n                  // Ensure the file is in the project's routes directory to prevent false positives in monorepos.\n                  event.filePath.startsWith(appDir) &&\n                  isApiRouteConvention(event.filePath)\n                ) {\n                  warnInvalidWebOutput();\n                }\n              }\n            }\n          }\n        );\n      }\n\n      // If React 19 is enabled, then add RSC middleware to the dev server.\n      if (isReactServerComponentsEnabled) {\n        this.bindRSCDevModuleInjectionHandler();\n        const rscMiddleware = createServerComponentsMiddleware(this.projectRoot, {\n          instanceMetroOptions: this.instanceMetroOptions,\n          rscPath: '/_flight',\n          ssrLoadModule: this.ssrLoadModule.bind(this),\n          ssrLoadModuleArtifacts: this.metroImportAsArtifactsAsync.bind(this),\n          useClientRouter: isReactServerActionsOnlyEnabled,\n          createModuleId: metro._createModuleId.bind(metro),\n          routerOptions,\n        });\n        this.rscRenderer = rscMiddleware;\n        middleware.use(rscMiddleware.middleware);\n        this.onReloadRscEvent = rscMiddleware.onReloadRscEvent;\n      }\n\n      // Append support for redirecting unhandled requests to the index.html page on web.\n      if (this.isTargetingWeb()) {\n        if (!useServerRendering) {\n          // This MUST run last since it's the fallback.\n          middleware.use(\n            new HistoryFallbackMiddleware(manifestMiddleware.getHandler().internal).getHandler()\n          );\n        } else {\n          middleware.use(\n            createRouteHandlerMiddleware(this.projectRoot, {\n              appDir,\n              routerRoot,\n              config,\n              ...config.exp.extra?.router,\n              bundleApiRoute: (functionFilePath) =>\n                this.ssrImportApiRoute(functionFilePath, { platform: 'web' }),\n              getStaticPageAsync: async (pathname) => {\n                // TODO: Add server rendering when RSC is enabled.\n                if (isReactServerComponentsEnabled) {\n                  // NOTE: This is a temporary hack to return the SPA/template index.html in development when RSC is enabled.\n                  // While this technically works, it doesn't provide the correct experience of server rendering the React code to HTML first.\n                  const html = await manifestMiddleware.getSingleHtmlTemplateAsync();\n                  return { content: html };\n                }\n\n                // Non-RSC apps will bundle the static HTML for a given pathname and respond with it.\n                return this.getStaticPageAsync(pathname);\n              },\n            })\n          );\n        }\n      }\n    } else {\n      // If React 19 is enabled, then add RSC middleware to the dev server.\n      if (isReactServerComponentsEnabled) {\n        this.bindRSCDevModuleInjectionHandler();\n        const rscMiddleware = createServerComponentsMiddleware(this.projectRoot, {\n          instanceMetroOptions: this.instanceMetroOptions,\n          rscPath: '/_flight',\n          ssrLoadModule: this.ssrLoadModule.bind(this),\n          ssrLoadModuleArtifacts: this.metroImportAsArtifactsAsync.bind(this),\n          useClientRouter: isReactServerActionsOnlyEnabled,\n          createModuleId: metro._createModuleId.bind(metro),\n          routerOptions,\n        });\n        this.rscRenderer = rscMiddleware;\n      }\n    }\n    // Extend the close method to ensure that we clean up the local info.\n    const originalClose = server.close.bind(server);\n\n    server.close = (callback?: (err?: Error) => void) => {\n      return originalClose((err?: Error) => {\n        this.instance = null;\n        this.metro = null;\n        this.hmrServer = null;\n        this.ssrHmrClients = new Map();\n        callback?.(err);\n      });\n    };\n\n    assertMetroPrivateServer(metro);\n    this.metro = metro;\n    this.hmrServer = hmrServer;\n    return {\n      server,\n      location: {\n        // The port is the main thing we want to send back.\n        port: options.port,\n        // localhost isn't always correct.\n        host: 'localhost',\n        // http is the only supported protocol on native.\n        url: `http://localhost:${options.port}`,\n        protocol: 'http',\n      },\n      middleware,\n      messageSocket,\n    };\n  }\n\n  private onReloadRscEvent: ((platform: string) => void) | null = null;\n\n  private async registerSsrHmrAsync(url: string, onReload: (platform: string[]) => void) {\n    if (!this.hmrServer || this.ssrHmrClients.has(url)) {\n      return;\n    }\n\n    debug('[SSR] Register HMR:', url);\n\n    const sendFn = (message: string) => {\n      const data = JSON.parse(String(message)) as { type: string; body: any };\n\n      switch (data.type) {\n        case 'bundle-registered':\n        case 'update-done':\n        case 'update-start':\n          break;\n        case 'update':\n          {\n            const update = data.body;\n            const {\n              isInitialUpdate,\n              added,\n              modified,\n              deleted,\n            }: {\n              isInitialUpdate?: boolean;\n              added: {\n                module: [number | string, string];\n                sourceURL: string;\n                sourceMappingURL: string;\n              }[];\n              modified: {\n                module: [number | string, string];\n                sourceURL: string;\n                sourceMappingURL: string;\n              }[];\n              deleted: (number | string)[];\n            } = update;\n\n            const hasUpdate = added.length || modified.length || deleted.length;\n\n            // NOTE: We throw away the updates and instead simply send a trigger to the client to re-fetch the server route.\n            if (!isInitialUpdate && hasUpdate) {\n              // Clear all SSR modules before sending the reload event. This ensures that the next event will rebuild the in-memory state from scratch.\n              // @ts-expect-error\n              if (typeof globalThis.__c === 'function') globalThis.__c();\n\n              const allModuleIds = new Set(\n                [...added, ...modified].map((m) => m.module[0]).concat(deleted)\n              );\n\n              const platforms = unique(\n                Array.from(allModuleIds)\n                  .map((moduleId) => {\n                    if (typeof moduleId !== 'string') {\n                      return null;\n                    }\n                    // Extract platforms from the module IDs.\n                    return moduleId.match(/[?&]platform=([\\w]+)/)?.[1] ?? null;\n                  })\n                  .filter(Boolean)\n              ) as string[];\n\n              onReload(platforms);\n            }\n          }\n          break;\n        case 'error':\n          // GraphNotFound can mean that we have an issue in metroOptions where the URL doesn't match the object props.\n          Log.error('[SSR] HMR Error: ' + JSON.stringify(data, null, 2));\n\n          if (data.body?.type === 'GraphNotFoundError') {\n            Log.error(\n              'Available SSR HMR keys:',\n              // @ts-expect-error\n              (this.metro?._bundler._revisionsByGraphId as Map).keys()\n            );\n          }\n          break;\n        default:\n          debug('Unknown HMR message:', data);\n          break;\n      }\n    };\n\n    const client = await this.hmrServer!.onClientConnect(url, sendFn);\n    this.ssrHmrClients.set(url, client);\n    // Opt in...\n    client.optedIntoHMR = true;\n    await this.hmrServer!._registerEntryPoint(client, url, sendFn);\n  }\n\n  public async waitForTypeScriptAsync(): Promise<boolean> {\n    if (!this.instance) {\n      throw new Error('Cannot wait for TypeScript without a running server.');\n    }\n\n    return new Promise<boolean>((resolve) => {\n      if (!this.metro) {\n        // This can happen when the run command is used and the server is already running in another\n        // process. In this case we can't wait for the TypeScript check to complete because we don't\n        // have access to the Metro server.\n        debug('Skipping TypeScript check because Metro is not running (headless).');\n        return resolve(false);\n      }\n\n      const off = metroWatchTypeScriptFiles({\n        projectRoot: this.projectRoot,\n        server: this.instance!.server,\n        metro: this.metro,\n        tsconfig: true,\n        throttle: true,\n        eventTypes: ['change', 'add'],\n        callback: async () => {\n          // Run once, this prevents the TypeScript project prerequisite from running on every file change.\n          off();\n          const { TypeScriptProjectPrerequisite } = await import(\n            '../../doctor/typescript/TypeScriptProjectPrerequisite.js'\n          );\n\n          try {\n            const req = new TypeScriptProjectPrerequisite(this.projectRoot);\n            await req.bootstrapAsync();\n            resolve(true);\n          } catch (error: any) {\n            // Ensure the process doesn't fail if the TypeScript check fails.\n            // This could happen during the install.\n            Log.log();\n            Log.error(\n              chalk.red`Failed to automatically setup TypeScript for your project. Try restarting the dev server to fix.`\n            );\n            Log.exception(error);\n            resolve(false);\n          }\n        },\n      });\n    });\n  }\n\n  public async startTypeScriptServices() {\n    return startTypescriptTypeGenerationAsync({\n      server: this.instance?.server,\n      metro: this.metro,\n      projectRoot: this.projectRoot,\n    });\n  }\n\n  protected getConfigModuleIds(): string[] {\n    return ['./metro.config.js', './metro.config.json', './rn-cli.config.js'];\n  }\n\n  // API Routes\n\n  private pendingRouteOperations = new Map<string, Promise<SSRModuleContentsResult | null>>();\n\n  // Bundle the API Route with Metro and return the string contents to be evaluated in the server.\n  private async bundleApiRoute(\n    filePath: string,\n    { platform }: { platform: string }\n  ): Promise<SSRModuleContentsResult | null | undefined> {\n    if (this.pendingRouteOperations.has(filePath)) {\n      return this.pendingRouteOperations.get(filePath);\n    }\n    const bundleAsync = async (): Promise<SSRModuleContentsResult> => {\n      try {\n        debug('Bundle API route:', this.instanceMetroOptions.routerRoot, filePath);\n        return await this.ssrLoadModuleContents(filePath, {\n          isExporting: this.instanceMetroOptions.isExporting,\n          platform,\n        });\n      } catch (error: any) {\n        const appDir = this.instanceMetroOptions?.routerRoot\n          ? path.join(this.projectRoot, this.instanceMetroOptions!.routerRoot!)\n          : undefined;\n        const relativePath = appDir ? path.relative(appDir, filePath) : filePath;\n\n        // Expected errors: invalid syntax, missing resolutions.\n        // Wrap with command error for better error messages.\n        const err = new CommandError(\n          'API_ROUTE',\n          chalk`Failed to bundle API Route: {bold ${relativePath}}\\n\\n` + error.message\n        );\n\n        for (const key in error) {\n          // @ts-expect-error\n          err[key] = error[key];\n        }\n\n        throw err;\n      } finally {\n        // pendingRouteOperations.delete(filepath);\n      }\n    };\n    const route = bundleAsync();\n\n    this.pendingRouteOperations.set(filePath, route);\n    return route;\n  }\n\n  private async ssrImportApiRoute(\n    filePath: string,\n    { platform }: { platform: string }\n  ): Promise<null | Record<string, Function> | Response> {\n    // TODO: Cache the evaluated function.\n    try {\n      const apiRoute = await this.bundleApiRoute(filePath, { platform });\n\n      if (!apiRoute?.src) {\n        return null;\n      }\n      return evalMetroNoHandling(this.projectRoot, apiRoute.src, apiRoute.filename);\n    } catch (error) {\n      // Format any errors that were thrown in the global scope of the evaluation.\n      if (error instanceof Error) {\n        try {\n          const htmlServerError = await getErrorOverlayHtmlAsync({\n            error,\n            projectRoot: this.projectRoot,\n            routerRoot: this.instanceMetroOptions.routerRoot!,\n          });\n\n          return new Response(htmlServerError, {\n            status: 500,\n            headers: {\n              'Content-Type': 'text/html',\n            },\n          });\n        } catch (internalError) {\n          debug('Failed to generate Metro server error UI for API Route error:', internalError);\n          throw error;\n        }\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  private invalidateApiRouteCache() {\n    this.pendingRouteOperations.clear();\n  }\n\n  // Ensure the global is available for SSR CSS modules to inject client updates.\n  private bindRSCDevModuleInjectionHandler() {\n    // Used by SSR CSS modules to broadcast client updates.\n    // @ts-expect-error\n    globalThis.__expo_rsc_inject_module = this.sendClientModule.bind(this);\n  }\n\n  // NOTE: This can only target a single platform at a time (web).\n  // used for sending RSC CSS to the root client in development.\n  private sendClientModule({ code, id }: { code: string; id: string }) {\n    this.broadcastMessage('sendDevCommand', {\n      name: 'module-import',\n      data: {\n        code,\n        id,\n      },\n    });\n  }\n\n  // Metro HMR\n\n  private setupHmr(url: URL) {\n    const onReload = (platforms: string[] = []) => {\n      // Send reload command to client from Fast Refresh code.\n\n      if (!platforms.length) {\n        // TODO: When is this called?\n        this.broadcastMessage('sendDevCommand', {\n          name: 'rsc-reload',\n        });\n      } else {\n        for (const platform of platforms) {\n          this.onReloadRscEvent?.(platform);\n          this.broadcastMessage('sendDevCommand', {\n            name: 'rsc-reload',\n            platform,\n          });\n        }\n      }\n    };\n\n    this.registerSsrHmrAsync(url.toString(), onReload);\n  }\n\n  // Direct Metro access\n\n  // Emulates the Metro dev server .bundle endpoint without having to go through a server.\n  private async _bundleDirectAsync(\n    resolvedEntryFilePath: string,\n    {\n      transformOptions,\n      resolverOptions,\n      graphOptions,\n      serializerOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      serializerOptions: {\n        modulesOnly: boolean;\n        runModule: boolean;\n        sourceMapUrl: string;\n        sourceUrl: string;\n        inlineSourceMap: boolean;\n        excludeSource: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ): Promise<BundleDirectResult> {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n    const buildNumber = this.metro.getNewBuildNumber();\n    const bundlePerfLogger = config.unstable_perfLoggerFactory?.('BUNDLING_REQUEST', {\n      key: buildNumber,\n    });\n\n    const onProgress: MetroOnProgress = (transformedFileCount: number, totalFileCount: number) => {\n      this.metro?._reporter?.update?.({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_transform_progressed',\n        transformedFileCount,\n        totalFileCount,\n      });\n    };\n\n    const revPromise = this.getMetroRevision(resolvedEntryFilePath, {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    });\n\n    bundlePerfLogger?.point('resolvingAndTransformingDependencies_start');\n    bundlePerfLogger?.annotate({\n      bool: {\n        initial_build: revPromise == null,\n      },\n    });\n    this.metro?._reporter.update({\n      buildID: getBuildID(buildNumber),\n      bundleDetails: {\n        bundleType: transformOptions.type,\n        dev: transformOptions.dev,\n        entryFile: resolvedEntryFilePath,\n        minify: transformOptions.minify,\n        platform: transformOptions.platform,\n        customResolverOptions: resolverOptions.customResolverOptions,\n        customTransformOptions: transformOptions.customTransformOptions ?? {},\n      },\n      isPrefetch: false,\n      type: 'bundle_build_started',\n    });\n\n    try {\n      let delta: DeltaResult;\n      let revision: GraphRevision;\n\n      try {\n        // TODO: Some bug in Metro/RSC causes this to break when changing imports in server components.\n        // We should resolve the bug because it results in ~6x faster bundling to reuse the graph revision.\n        if (transformOptions.customTransformOptions?.environment === 'react-server') {\n          const props = await this.metro.getBundler().initializeGraph(\n            // NOTE: Using absolute path instead of relative input path is a breaking change.\n            // entryFile,\n            resolvedEntryFilePath,\n\n            transformOptions,\n            resolverOptions,\n            {\n              onProgress,\n              shallow: graphOptions.shallow,\n              lazy: graphOptions.lazy,\n            }\n          );\n          delta = props.delta;\n          revision = props.revision;\n        } else {\n          const props = await (revPromise != null\n            ? this.metro.getBundler().updateGraph(await revPromise, false)\n            : this.metro.getBundler().initializeGraph(\n                // NOTE: Using absolute path instead of relative input path is a breaking change.\n                // entryFile,\n                resolvedEntryFilePath,\n\n                transformOptions,\n                resolverOptions,\n                {\n                  onProgress,\n                  shallow: graphOptions.shallow,\n                  lazy: graphOptions.lazy,\n                }\n              ));\n          delta = props.delta;\n          revision = props.revision;\n        }\n      } catch (error) {\n        if (error instanceof Error) {\n          // Space out build failures.\n          const cause = error.cause as undefined | { _expoImportStack?: string };\n          if (cause && '_expoImportStack' in cause) {\n            error.message += '\\n\\n' + cause._expoImportStack;\n          }\n        }\n\n        throw error;\n      }\n\n      bundlePerfLogger?.annotate({\n        int: {\n          graph_node_count: revision.graph.dependencies.size,\n        },\n      });\n      bundlePerfLogger?.point('resolvingAndTransformingDependencies_end');\n      bundlePerfLogger?.point('serializingBundle_start');\n\n      const shouldAddToIgnoreList = this.metro._shouldAddModuleToIgnoreList.bind(this.metro);\n\n      const serializer = this.getMetroSerializer();\n\n      const bundle = await serializer(\n        // NOTE: Using absolute path instead of relative input path is a breaking change.\n        // entryFile,\n        resolvedEntryFilePath,\n\n        revision.prepend as any,\n        revision.graph as any,\n        {\n          asyncRequireModulePath: await this.metro._resolveRelativePath(\n            config.transformer.asyncRequireModulePath,\n            {\n              relativeTo: 'project',\n              resolverOptions,\n              transformOptions,\n            }\n          ),\n          // ...serializerOptions,\n          processModuleFilter: config.serializer.processModuleFilter,\n          createModuleId: this.metro._createModuleId,\n          getRunModuleStatement: config.serializer.getRunModuleStatement,\n          includeAsyncPaths: graphOptions.lazy,\n          dev: transformOptions.dev,\n          projectRoot: config.projectRoot,\n          modulesOnly: serializerOptions.modulesOnly,\n          runBeforeMainModule: config.serializer.getModulesRunBeforeMainModule(\n            resolvedEntryFilePath\n            // path.relative(config.projectRoot, entryFile)\n          ),\n          runModule: serializerOptions.runModule,\n          sourceMapUrl: serializerOptions.sourceMapUrl,\n          sourceUrl: serializerOptions.sourceUrl,\n          inlineSourceMap: serializerOptions.inlineSourceMap,\n          serverRoot: config.server.unstable_serverRoot ?? config.projectRoot,\n          shouldAddToIgnoreList,\n\n          // @ts-expect-error: passed to our serializer to enable non-serial return values.\n          serializerOptions,\n        }\n      );\n\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_done',\n      });\n\n      bundlePerfLogger?.point('serializingBundle_end');\n\n      let bundleCode: string | null = null;\n      let bundleMap: string | null = null;\n\n      // @ts-expect-error: If the output is multi-bundle...\n      if (serializerOptions.output === 'static') {\n        try {\n          const parsed = typeof bundle === 'string' ? JSON.parse(bundle) : bundle;\n\n          assert(\n            'artifacts' in parsed && Array.isArray(parsed.artifacts),\n            'Expected serializer to return an object with key artifacts to contain an array of serial assets.'\n          );\n\n          const artifacts = parsed.artifacts as SerialAsset[];\n          const assets = parsed.assets;\n\n          const bundleCode = artifacts.filter((asset) => asset.type === 'js')[0];\n          const bundleMap = artifacts.filter((asset) => asset.type === 'map')?.[0]?.source ?? '';\n\n          return {\n            numModifiedFiles: delta.reset\n              ? delta.added.size + revision.prepend.length\n              : delta.added.size + delta.modified.size + delta.deleted.size,\n            lastModifiedDate: revision.date,\n            nextRevId: revision.id,\n            bundle: bundleCode.source,\n            map: bundleMap,\n            artifacts,\n            assets,\n          };\n        } catch (error: any) {\n          throw new Error(\n            'Serializer did not return expected format. The project copy of `expo/metro-config` may be out of date. Error: ' +\n              error.message\n          );\n        }\n      }\n\n      if (typeof bundle === 'string') {\n        bundleCode = bundle;\n\n        // Create the source map in a second pass...\n        let { prepend, graph } = revision;\n        if (serializerOptions.modulesOnly) {\n          prepend = [];\n        }\n\n        bundleMap = await sourceMapStringAsync(\n          [\n            //\n            ...prepend,\n            ...this.metro._getSortedModules(graph),\n          ],\n          {\n            excludeSource: serializerOptions.excludeSource,\n            processModuleFilter: config.serializer.processModuleFilter,\n            shouldAddToIgnoreList,\n          }\n        );\n      } else {\n        bundleCode = bundle.code;\n        bundleMap = bundle.map;\n      }\n\n      return {\n        numModifiedFiles: delta.reset\n          ? delta.added.size + revision.prepend.length\n          : delta.added.size + delta.modified.size + delta.deleted.size,\n        lastModifiedDate: revision.date,\n        nextRevId: revision.id,\n        bundle: bundleCode,\n        map: bundleMap,\n      };\n    } catch (error) {\n      // Mark the error so we know how to format and return it later.\n      // @ts-expect-error\n      error[IS_METRO_BUNDLE_ERROR_SYMBOL] = true;\n\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_failed',\n      });\n\n      throw error;\n    }\n  }\n\n  private getMetroSerializer() {\n    return (\n      this.metro?._config?.serializer.customSerializer ||\n      ((entryPoint, preModules, graph, options) =>\n        bundleToString(baseJSBundle(entryPoint, preModules, graph, options)).code)\n    );\n  }\n\n  private getMetroRevision(\n    resolvedEntryFilePath: string,\n    {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n\n    const graphId = getGraphId(resolvedEntryFilePath, transformOptions, {\n      unstable_allowRequireContext: config.transformer.unstable_allowRequireContext,\n      resolverOptions,\n      shallow: graphOptions.shallow,\n      lazy: graphOptions.lazy,\n    });\n    return this.metro.getBundler().getRevisionByGraphId(graphId);\n  }\n\n  private async resolveRelativePathAsync(\n    moduleId: string,\n    {\n      resolverOptions,\n      transformOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'cannot invoke resolveRelativePathAsync without metro instance');\n    return await this.metro._resolveRelativePath(convertPathToModuleSpecifier(moduleId), {\n      relativeTo: 'server',\n      resolverOptions,\n      transformOptions,\n    });\n  }\n}\n\nfunction getBuildID(buildNumber: number): string {\n  return buildNumber.toString(36);\n}\n\nfunction wrapBundle(str: string) {\n  // Skip the metro runtime so debugging is a bit easier.\n  // Replace the __r() call with an export statement.\n  // Use gm to apply to the last require line. This is needed when the bundle has side-effects.\n  return str.replace(/^(__r\\(.*\\);)$/gm, 'module.exports = $1');\n}\n\nasync function sourceMapStringAsync(\n  modules: readonly import('metro/src/DeltaBundler/types').Module<any>[],\n  options: SourceMapGeneratorOptions\n): Promise<string> {\n  return (await sourceMapGeneratorNonBlocking(modules, options)).toString(undefined, {\n    excludeSource: options.excludeSource,\n  });\n}\n\nfunction unique<T>(array: T[]): T[] {\n  return Array.from(new Set(array));\n}\n"],"names":["MetroBundlerDevServer","debug","require","EXPO_GO_METRO_PORT","DEV_CLIENT_METRO_PORT","BundlerDevServer","name","resolvePortAsync","options","port","devClient","Number","process","env","RCT_METRO_PORT","getFreePortAsync","exportExpoRouterApiRoutesAsync","includeSourceMaps","outputDir","prerenderManifest","platform","routerRoot","instanceMetroOptions","assert","appDir","path","join","projectRoot","manifest","getExpoRouterRoutesManifestAsync","files","Map","rscPath","isReactServerComponentsEnabled","apiRoutes","find","route","page","startsWith","push","file","resolveFrom","namedRegex","routeKeys","rsc","filepath","isAbsolute","contents","bundleApiRoute","artifactFilename","convertPathToModuleSpecifier","relative","replace","src","map","artifactBasename","encodeURIComponent","basename","parsedMap","JSON","parse","set","stringify","version","sources","source","sourcesContent","Array","length","fill","names","mappings","apiRouteId","targetDomain","htmlRoutes","exp","getConfig","fetchManifest","extra","router","preserveRedirectAndRewrites","asJson","CommandError","getServerManifestAsync","getBuildTimeServerManifestAsync","getManifest","ssrLoadModule","environment","isReactServerRoutesEnabled","serverManifest","htmlManifest","getStaticRenderFunctionAsync","url","getDevServerUrlOrAssert","getStaticContent","preserveApiRoutes","renderAsync","URL","getStaticResourcesAsync","mainModuleName","clientBoundaries","mode","minify","isExporting","baseUrl","reactCompiler","asyncRoutes","resolvedMainModuleName","resolveMainModuleName","metroImportAsArtifactsAsync","splitChunks","EXPO_NO_BUNDLE_SPLITTING","serializerIncludeMaps","lazy","shouldEnableAsyncImports","bytecode","getStaticPageAsync","pathname","devBundleUrlPathname","createBundleUrlPath","bundleStaticHtml","location","artifacts","resources","staticHtml","Promise","all","content","serializeHtmlWithAssets","template","devBundleUrl","hydrate","EXPO_WEB_DEV_HYDRATE","filePath","specificOptions","results","ssrLoadModuleContents","serializerOutput","assets","filename","metroLoadModuleContents","extraOptions","opts","inlineSourceMap","engine","expoBundleOptions","getMetroDirectBundleOptions","resolverOptions","customResolverOptions","dev","transformOptions","hot","type","unstable_transformProfile","customTransformOptions","Object","create","runtimeBytecodeVersion","resolvedEntryFilePath","resolveRelativePathAsync","createBundleOsPath","_bundleDirectAsync","graphOptions","shallow","serializerOptions","modulesOnly","runModule","sourceUrl","sourceMapUrl","bundle","rest","scriptContents","wrapBundle","cachedSourceMaps","nativeExportBundleAsync","singlePageReactServerComponentExportAsync","legacySinglePageExportBundleAsync","getReactServerReferences","unique","filter","a","artifact","metadata","reactServerReferences","ref","fileURLToFilePath","flat","Boolean","reactClientReferences","serverActionReferencesInServer","cssModules","rscRenderer","getExpoRouterClientReferencesAsync","domRoot","processClientBoundaries","newReactServerReferences","Error","allKnownReactServerReferences","nestedClientBoundaries","exportServerActionsAsync","entryPoints","hasUniqueClientBoundaries","some","boundary","includes","concat","serverRoot","getMetroServerRoot","clientBoundariesAsOpaqueIds","toPosixPath","moduleIdToSplitBundle","paths","values","reduce","acc","ssrManifest","keys","forEach","routerOptions","exportRoutesAsync","fromEntries","from","entries","key","value","output","watchEnvironmentVariables","instance","metro","envFiles","runtimeEnv","getFiles","NODE_ENV","fileName","observeFileChanges","server","load","force","startImplementationAsync","urlCreator","getUrlCreator","config","skipSDKVersionRequirement","experiments","reactServerComponentRoutes","reactServerFunctions","isReactServerActionsOnlyEnabled","useServerRendering","web","hasApiRoutes","getBaseUrlFromExpoConfig","getAsyncRoutesFromExpoConfig","getRouterDirectoryModuleIdWithManifest","origin","configPath","dynamicConfigPath","staticConfigPath","configFileName","parsedOptions","maxWorkers","resetCache","resetDevServer","EXPO_DEV_SERVER_ORIGIN","hmrServer","middleware","messageSocket","instantiateMetroAsync","manifestMiddleware","getManifestMiddlewareAsync","prependMiddleware","ContextModuleSourceMapsMiddleware","getHandler","use","InterstitialPageMiddleware","scheme","DevToolsPluginMiddleware","devToolsPluginManager","deepLinkMiddleware","RuntimeRedirectMiddleware","getLocation","runtime","constructDevClientUrl","constructUrl","domComponentRenderer","createDomComponentsMiddleware","metroRoot","CreateFileMiddleware","isTargetingWeb","ServeStaticMiddleware","FaviconMiddleware","observeAnyFileChanges","events","invalidateApiRouteCache","hasWarnedAboutApiRoutes","event","isApiRouteConvention","warnInvalidWebOutput","bindRSCDevModuleInjectionHandler","rscMiddleware","createServerComponentsMiddleware","bind","ssrLoadModuleArtifacts","useClientRouter","createModuleId","_createModuleId","onReloadRscEvent","HistoryFallbackMiddleware","internal","createRouteHandlerMiddleware","functionFilePath","ssrImportApiRoute","html","getSingleHtmlTemplateAsync","originalClose","close","callback","err","ssrHmrClients","assertMetroPrivateServer","host","protocol","registerSsrHmrAsync","onReload","has","sendFn","message","data","String","update","body","isInitialUpdate","added","modified","deleted","hasUpdate","globalThis","__c","allModuleIds","Set","m","module","platforms","moduleId","match","Log","error","_bundler","_revisionsByGraphId","client","onClientConnect","optedIntoHMR","_registerEntryPoint","waitForTypeScriptAsync","resolve","off","metroWatchTypeScriptFiles","tsconfig","throttle","eventTypes","TypeScriptProjectPrerequisite","req","bootstrapAsync","log","chalk","red","exception","startTypeScriptServices","startTypescriptTypeGenerationAsync","getConfigModuleIds","pendingRouteOperations","get","bundleAsync","undefined","relativePath","apiRoute","evalMetroNoHandling","htmlServerError","getErrorOverlayHtmlAsync","Response","status","headers","internalError","clear","__expo_rsc_inject_module","sendClientModule","code","id","broadcastMessage","setupHmr","toString","_config","buildNumber","getNewBuildNumber","bundlePerfLogger","unstable_perfLoggerFactory","onProgress","transformedFileCount","totalFileCount","_reporter","buildID","getBuildID","revPromise","getMetroRevision","point","annotate","bool","initial_build","bundleDetails","bundleType","entryFile","isPrefetch","delta","revision","props","getBundler","initializeGraph","updateGraph","cause","_expoImportStack","int","graph_node_count","graph","dependencies","size","shouldAddToIgnoreList","_shouldAddModuleToIgnoreList","serializer","getMetroSerializer","prepend","asyncRequireModulePath","_resolveRelativePath","transformer","relativeTo","processModuleFilter","getRunModuleStatement","includeAsyncPaths","runBeforeMainModule","getModulesRunBeforeMainModule","unstable_serverRoot","bundleCode","bundleMap","parsed","isArray","asset","numModifiedFiles","reset","lastModifiedDate","date","nextRevId","sourceMapStringAsync","_getSortedModules","excludeSource","IS_METRO_BUNDLE_ERROR_SYMBOL","customSerializer","entryPoint","preModules","bundleToString","baseJSBundle","graphId","getGraphId","unstable_allowRequireContext","getRevisionByGraphId","extras","res","evalMetroAndWrapFunctions","str","modules","sourceMapGeneratorNonBlocking","array"],"mappings":"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"}
=======
{"version":3,"sources":["../../../../../src/start/server/metro/MetroBundlerDevServer.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { getConfig } from '@expo/config';\nimport * as runtimeEnv from '@expo/env';\nimport { SerialAsset } from '@expo/metro-config/build/serializer/serializerAssets';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport { TransformInputOptions } from 'metro';\nimport baseJSBundle from 'metro/src/DeltaBundler/Serializers/baseJSBundle';\nimport {\n  sourceMapGeneratorNonBlocking,\n  type SourceMapGeneratorOptions,\n} from 'metro/src/DeltaBundler/Serializers/sourceMapGenerator';\nimport bundleToString from 'metro/src/lib/bundleToString';\nimport { TransformProfile } from 'metro-babel-transformer';\nimport type { CustomResolverOptions } from 'metro-resolver/src/types';\nimport path from 'path';\n\nimport { createRouteHandlerMiddleware } from './createServerRouteMiddleware';\nimport { ExpoRouterServerManifestV1, fetchManifest } from './fetchRouterManifest';\nimport { instantiateMetroAsync } from './instantiateMetro';\nimport { getErrorOverlayHtmlAsync } from './metroErrorInterface';\nimport { MetroPrivateServer, assertMetroPrivateServer } from './metroPrivateServer';\nimport { metroWatchTypeScriptFiles } from './metroWatchTypeScriptFiles';\nimport {\n  getRouterDirectoryModuleIdWithManifest,\n  hasWarnedAboutApiRoutes,\n  isApiRouteConvention,\n  warnInvalidWebOutput,\n} from './router';\nimport { serializeHtmlWithAssets } from './serializeHtml';\nimport { observeAnyFileChanges, observeFileChanges } from './waitForMetroToObserveTypeScriptFile';\nimport { BundleAssetWithFileHashes, ExportAssetMap } from '../../../export/saveAssets';\nimport { Log } from '../../../log';\nimport getDevClientProperties from '../../../utils/analytics/getDevClientProperties';\nimport { env } from '../../../utils/env';\nimport { CommandError } from '../../../utils/errors';\nimport { getFreePortAsync } from '../../../utils/port';\nimport { logEventAsync } from '../../../utils/telemetry';\nimport { BundlerDevServer, BundlerStartOptions, DevServerInstance } from '../BundlerDevServer';\nimport {\n  cachedSourceMaps,\n  evalMetroAndWrapFunctions,\n  evalMetroNoHandling,\n} from '../getStaticRenderFunctions';\nimport { ContextModuleSourceMapsMiddleware } from '../middleware/ContextModuleSourceMapsMiddleware';\nimport { CreateFileMiddleware } from '../middleware/CreateFileMiddleware';\nimport { DevToolsPluginMiddleware } from '../middleware/DevToolsPluginMiddleware';\nimport { FaviconMiddleware } from '../middleware/FaviconMiddleware';\nimport { HistoryFallbackMiddleware } from '../middleware/HistoryFallbackMiddleware';\nimport { InterstitialPageMiddleware } from '../middleware/InterstitialPageMiddleware';\nimport { resolveMainModuleName } from '../middleware/ManifestMiddleware';\nimport { ReactDevToolsPageMiddleware } from '../middleware/ReactDevToolsPageMiddleware';\nimport {\n  DeepLinkHandler,\n  RuntimeRedirectMiddleware,\n} from '../middleware/RuntimeRedirectMiddleware';\nimport { ServeStaticMiddleware } from '../middleware/ServeStaticMiddleware';\nimport {\n  ExpoMetroOptions,\n  convertPathToModuleSpecifier,\n  createBundleUrlPath,\n  getAsyncRoutesFromExpoConfig,\n  getBaseUrlFromExpoConfig,\n  getMetroDirectBundleOptions,\n  shouldEnableAsyncImports,\n} from '../middleware/metroOptions';\nimport { prependMiddleware } from '../middleware/mutations';\nimport { startTypescriptTypeGenerationAsync } from '../type-generation/startTypescriptTypeGeneration';\n\nexport type ExpoRouterRuntimeManifest = Awaited<\n  ReturnType<typeof import('expo-router/build/static/renderStaticContent').getManifest>\n>;\n\ntype MetroOnProgress = NonNullable<\n  import('metro/src/DeltaBundler/types').Options<void>['onProgress']\n>;\n\nconst debug = require('debug')('expo:start:server:metro') as typeof console.log;\n\nconst getGraphId = require('metro/src/lib/getGraphId') as (\n  entryFile: string,\n  options: any,\n  etc: {\n    shallow: boolean;\n    lazy: boolean;\n    unstable_allowRequireContext: boolean;\n    resolverOptions: unknown;\n  }\n) => string;\n\n/** Default port to use for apps running in Expo Go. */\nconst EXPO_GO_METRO_PORT = 8081;\n\n/** Default port to use for apps that run in standard React Native projects or Expo Dev Clients. */\nconst DEV_CLIENT_METRO_PORT = 8081;\n\nexport class MetroBundlerDevServer extends BundlerDevServer {\n  private metro: MetroPrivateServer | null = null;\n\n  get name(): string {\n    return 'metro';\n  }\n\n  async resolvePortAsync(options: Partial<BundlerStartOptions> = {}): Promise<number> {\n    const port =\n      // If the manually defined port is busy then an error should be thrown...\n      options.port ??\n      // Otherwise use the default port based on the runtime target.\n      (options.devClient\n        ? // Don't check if the port is busy if we're using the dev client since most clients are hardcoded to 8081.\n          Number(process.env.RCT_METRO_PORT) || DEV_CLIENT_METRO_PORT\n        : // Otherwise (running in Expo Go) use a free port that falls back on the classic 8081 port.\n          await getFreePortAsync(EXPO_GO_METRO_PORT));\n\n    return port;\n  }\n\n  async exportExpoRouterApiRoutesAsync({\n    includeSourceMaps,\n    outputDir,\n    prerenderManifest,\n  }: {\n    includeSourceMaps?: boolean;\n    outputDir: string;\n    // This does not contain the API routes info.\n    prerenderManifest: ExpoRouterServerManifestV1;\n  }): Promise<{ files: ExportAssetMap; manifest: ExpoRouterServerManifestV1<string> }> {\n    const { routerRoot } = this.instanceMetroOptions;\n    assert(\n      routerRoot != null,\n      'The server must be started before calling exportExpoRouterApiRoutesAsync.'\n    );\n\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const manifest = await this.getExpoRouterRoutesManifestAsync({ appDir });\n\n    const files: ExportAssetMap = new Map();\n\n    for (const route of manifest.apiRoutes) {\n      const filepath = path.join(appDir, route.file);\n      const contents = await this.bundleApiRoute(filepath);\n      const artifactFilename = path.join(\n        outputDir,\n        path.relative(appDir, filepath.replace(/\\.[tj]sx?$/, '.js'))\n      );\n      if (contents) {\n        let src = contents.src;\n        if (includeSourceMaps && contents.map) {\n          // TODO(kitten): Merge the source map transformer in the future\n          // https://github.com/expo/expo/blob/0dffdb15/packages/%40expo/metro-config/src/serializer/serializeChunks.ts#L422-L439\n          // Alternatively, check whether `sourcesRoot` helps here\n          const artifactBasename = encodeURIComponent(path.basename(artifactFilename) + '.map');\n          src = src.replace(\n            /\\/\\/# sourceMappingURL=.*/g,\n            `//# sourceMappingURL=${artifactBasename}`\n          );\n\n          const parsedMap = JSON.parse(contents.map);\n          files.set(artifactFilename + '.map', {\n            contents: JSON.stringify({\n              version: parsedMap.version,\n              sources: parsedMap.sources.map((source: string) => {\n                source =\n                  typeof source === 'string' && source.startsWith(this.projectRoot)\n                    ? path.relative(this.projectRoot, source)\n                    : source;\n                return convertPathToModuleSpecifier(source);\n              }),\n              sourcesContent: new Array(parsedMap.sources.length).fill(null),\n              names: parsedMap.names,\n              mappings: parsedMap.mappings,\n            }),\n            targetDomain: 'server',\n          });\n        }\n        files.set(artifactFilename, {\n          contents: src,\n          targetDomain: 'server',\n        });\n      }\n      // Remap the manifest files to represent the output files.\n      route.file = artifactFilename;\n    }\n\n    return {\n      manifest: {\n        ...manifest,\n        htmlRoutes: prerenderManifest.htmlRoutes,\n      },\n      files,\n    };\n  }\n\n  async getExpoRouterRoutesManifestAsync({ appDir }: { appDir: string }) {\n    // getBuiltTimeServerManifest\n    const { exp } = getConfig(this.projectRoot);\n    const manifest = await fetchManifest(this.projectRoot, {\n      ...exp.extra?.router?.platformRoutes,\n      asJson: true,\n      appDir,\n    });\n\n    if (!manifest) {\n      throw new CommandError(\n        'EXPO_ROUTER_SERVER_MANIFEST',\n        'Unexpected error: server manifest could not be fetched.'\n      );\n    }\n\n    return manifest;\n  }\n\n  async getStaticRenderFunctionAsync(): Promise<{\n    serverManifest: ExpoRouterServerManifestV1;\n    manifest: ExpoRouterRuntimeManifest;\n    renderAsync: (path: string) => Promise<string>;\n  }> {\n    const url = this.getDevServerUrl()!;\n\n    const { getStaticContent, getManifest, getBuildTimeServerManifestAsync } =\n      await this.ssrLoadModule<typeof import('expo-router/build/static/renderStaticContent')>(\n        'expo-router/node/render.js'\n      );\n\n    const { exp } = getConfig(this.projectRoot);\n\n    return {\n      serverManifest: await getBuildTimeServerManifestAsync(),\n      // Get routes from Expo Router.\n      manifest: await getManifest({ preserveApiRoutes: false, ...exp.extra?.router }),\n      // Get route generating function\n      async renderAsync(path: string) {\n        return await getStaticContent(new URL(path, url));\n      },\n    };\n  }\n\n  async getStaticResourcesAsync({\n    includeSourceMaps,\n    mainModuleName,\n  }: {\n    includeSourceMaps?: boolean;\n    mainModuleName?: string;\n  } = {}) {\n    const { mode, minify, isExporting, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        routerRoot != null &&\n        reactCompiler != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticResourcesAsync.'\n    );\n\n    const platform = 'web';\n\n    const resolvedMainModuleName =\n      mainModuleName ?? './' + resolveMainModuleName(this.projectRoot, { platform });\n    return await this.metroImportAsArtifactsAsync(resolvedMainModuleName, {\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      minify,\n      environment: 'client',\n      serializerIncludeMaps: includeSourceMaps,\n      mainModuleName: resolvedMainModuleName,\n      lazy: shouldEnableAsyncImports(this.projectRoot),\n      asyncRoutes,\n      baseUrl,\n      isExporting,\n      routerRoot,\n      reactCompiler,\n      bytecode: false,\n    });\n  }\n\n  private async getStaticPageAsync(pathname: string) {\n    const { mode, isExporting, baseUrl, reactCompiler, routerRoot, asyncRoutes } =\n      this.instanceMetroOptions;\n    assert(\n      mode != null &&\n        isExporting != null &&\n        baseUrl != null &&\n        reactCompiler != null &&\n        routerRoot != null &&\n        asyncRoutes != null,\n      'The server must be started before calling getStaticPageAsync.'\n    );\n    const platform = 'web';\n\n    const devBundleUrlPathname = createBundleUrlPath({\n      splitChunks: isExporting && !env.EXPO_NO_BUNDLE_SPLITTING,\n      platform,\n      mode,\n      environment: 'client',\n      reactCompiler,\n      mainModuleName: resolveMainModuleName(this.projectRoot, { platform }),\n      lazy: shouldEnableAsyncImports(this.projectRoot),\n      baseUrl,\n      isExporting,\n      asyncRoutes,\n      routerRoot,\n      bytecode: false,\n    });\n\n    const bundleStaticHtml = async (): Promise<string> => {\n      const { getStaticContent } = await this.ssrLoadModule<\n        typeof import('expo-router/build/static/renderStaticContent')\n      >('expo-router/node/render.js', {\n        minify: false,\n        mode,\n        isExporting,\n        platform,\n      });\n\n      const location = new URL(pathname, this.getDevServerUrl()!);\n      return await getStaticContent(location);\n    };\n\n    const [{ artifacts: resources }, staticHtml] = await Promise.all([\n      this.getStaticResourcesAsync(),\n      bundleStaticHtml(),\n    ]);\n    const content = serializeHtmlWithAssets({\n      isExporting,\n      resources,\n      template: staticHtml,\n      devBundleUrl: devBundleUrlPathname,\n      baseUrl,\n    });\n    return {\n      content,\n      resources,\n    };\n  }\n\n  // Set when the server is started.\n  private instanceMetroOptions: Partial<ExpoMetroOptions> = {};\n\n  private async ssrLoadModule<T extends Record<string, any>>(\n    filePath: string,\n    specificOptions: Partial<ExpoMetroOptions> = {}\n  ): Promise<T> {\n    const res = await this.ssrLoadModuleContents(filePath, specificOptions);\n    return evalMetroAndWrapFunctions<T>(this.projectRoot, res.src, res.filename);\n  }\n\n  private async metroImportAsArtifactsAsync(\n    filePath: string,\n    specificOptions: Partial<Omit<ExpoMetroOptions, 'serializerOutput'>> = {}\n  ) {\n    const results = await this.ssrLoadModuleContents(filePath, {\n      serializerOutput: 'static',\n      ...specificOptions,\n    });\n\n    // NOTE: This could potentially need more validation in the future.\n    if (results.artifacts && results.assets) {\n      return {\n        artifacts: results.artifacts,\n        assets: results.assets,\n        src: results.src,\n        filename: results.filename,\n        map: results.map,\n      };\n    }\n    throw new CommandError('Invalid bundler results: ' + results);\n  }\n\n  private async metroLoadModuleContents(\n    filePath: string,\n    specificOptions: ExpoMetroOptions,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ) {\n    const { baseUrl } = this.instanceMetroOptions;\n    assert(baseUrl != null, 'The server must be started before calling metroLoadModuleContents.');\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      // mainModuleName: filePath,\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      // bytecode: false,\n      // Bundle in Node.js mode for SSR.\n      environment: 'node',\n      // platform: 'web',\n      // mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n      baseUrl,\n      // routerRoot,\n      // isExporting,\n      ...specificOptions,\n    };\n\n    const expoBundleOptions = getMetroDirectBundleOptions(opts);\n\n    const resolverOptions = {\n      customResolverOptions: expoBundleOptions.customResolverOptions ?? {},\n      dev: expoBundleOptions.dev ?? true,\n    };\n\n    const transformOptions: TransformInputOptions = {\n      dev: expoBundleOptions.dev ?? true,\n      hot: true,\n      minify: expoBundleOptions.minify ?? false,\n      type: 'module',\n      unstable_transformProfile:\n        extraOptions.unstable_transformProfile ??\n        expoBundleOptions.unstable_transformProfile ??\n        'default',\n      customTransformOptions: expoBundleOptions.customTransformOptions ?? Object.create(null),\n      platform: expoBundleOptions.platform ?? 'web',\n      runtimeBytecodeVersion: expoBundleOptions.runtimeBytecodeVersion,\n    };\n\n    const resolvedEntryFilePath = await this.resolveRelativePathAsync(filePath, {\n      resolverOptions,\n      transformOptions,\n    });\n\n    // Use fully qualified URL with all options to represent the file path that's used for source maps and HMR. This prevents collisions.\n    const filename = createBundleUrlPath({\n      ...opts,\n      mainModuleName: resolvedEntryFilePath,\n    });\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    const results = await this._bundleDirectAsync(resolvedEntryFilePath, {\n      graphOptions: {\n        lazy: expoBundleOptions.lazy ?? false,\n        shallow: expoBundleOptions.shallow ?? false,\n      },\n      resolverOptions,\n      serializerOptions: {\n        ...expoBundleOptions.serializerOptions,\n\n        inlineSourceMap: expoBundleOptions.inlineSourceMap ?? false,\n        modulesOnly: expoBundleOptions.modulesOnly ?? false,\n        runModule: expoBundleOptions.runModule ?? true,\n        // @ts-expect-error\n        sourceUrl: expoBundleOptions.sourceUrl,\n        // @ts-expect-error\n        sourceMapUrl: extraOptions.sourceMapUrl ?? expoBundleOptions.sourceMapUrl,\n      },\n      transformOptions,\n    });\n\n    return {\n      ...results,\n      filename,\n    };\n  }\n\n  private async ssrLoadModuleContents(\n    filePath: string,\n    specificOptions: Partial<ExpoMetroOptions> = {}\n  ) {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling ssrLoadModuleContents.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      // TODO: Possibly issues with using an absolute path here...\n      mainModuleName: convertPathToModuleSpecifier(filePath),\n      lazy: false,\n      asyncRoutes: false,\n      inlineSourceMap: false,\n      engine: 'hermes',\n      minify: false,\n      bytecode: false,\n      // Bundle in Node.js mode for SSR.\n      environment: 'node',\n      platform: 'web',\n      mode: 'development',\n      //\n      ...this.instanceMetroOptions,\n\n      // Mostly disable compiler in SSR bundles.\n      reactCompiler: false,\n      baseUrl,\n      routerRoot,\n      isExporting,\n\n      ...specificOptions,\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    const { filename, bundle, map, ...rest } = await this.metroLoadModuleContents(filePath, opts);\n    const scriptContents = wrapBundle(bundle);\n\n    if (map) {\n      debug('Registering SSR source map for:', filename);\n      cachedSourceMaps.set(filename, { url: this.projectRoot, map });\n    } else {\n      debug('No SSR source map found for:', filename);\n    }\n\n    return {\n      ...rest,\n      src: scriptContents,\n      filename,\n      map,\n    };\n  }\n\n  async legacySinglePageExportBundleAsync(\n    options: Omit<\n      ExpoMetroOptions,\n      'baseUrl' | 'routerRoot' | 'asyncRoutes' | 'isExporting' | 'serializerOutput' | 'environment'\n    >,\n    extraOptions: {\n      sourceMapUrl?: string;\n      unstable_transformProfile?: TransformProfile;\n    } = {}\n  ): Promise<{ artifacts: SerialAsset[]; assets: readonly BundleAssetWithFileHashes[] }> {\n    const { baseUrl, routerRoot, isExporting } = this.instanceMetroOptions;\n    assert(\n      baseUrl != null && routerRoot != null && isExporting != null,\n      'The server must be started before calling legacySinglePageExportBundleAsync.'\n    );\n\n    const opts: ExpoMetroOptions = {\n      ...this.instanceMetroOptions,\n      baseUrl,\n      routerRoot,\n      isExporting,\n      ...options,\n      environment: 'client',\n      serializerOutput: 'static',\n    };\n\n    // https://github.com/facebook/metro/blob/2405f2f6c37a1b641cc379b9c733b1eff0c1c2a1/packages/metro/src/lib/parseOptionsFromUrl.js#L55-L87\n    if (!opts.mainModuleName.startsWith('/')) {\n      opts.mainModuleName = './' + opts.mainModuleName;\n    }\n\n    const output = await this.metroLoadModuleContents(opts.mainModuleName, opts, extraOptions);\n\n    return {\n      artifacts: output.artifacts!,\n      assets: output.assets!,\n    };\n  }\n\n  async watchEnvironmentVariables() {\n    if (!this.instance) {\n      throw new Error(\n        'Cannot observe environment variable changes without a running Metro instance.'\n      );\n    }\n    if (!this.metro) {\n      // This can happen when the run command is used and the server is already running in another\n      // process.\n      debug('Skipping Environment Variable observation because Metro is not running (headless).');\n      return;\n    }\n\n    const envFiles = runtimeEnv\n      .getFiles(process.env.NODE_ENV)\n      .map((fileName) => path.join(this.projectRoot, fileName));\n\n    observeFileChanges(\n      {\n        metro: this.metro,\n        server: this.instance.server,\n      },\n      envFiles,\n      () => {\n        debug('Reloading environment variables...');\n        // Force reload the environment variables.\n        runtimeEnv.load(this.projectRoot, { force: true });\n      }\n    );\n  }\n\n  protected async startImplementationAsync(\n    options: BundlerStartOptions\n  ): Promise<DevServerInstance> {\n    options.port = await this.resolvePortAsync(options);\n    this.urlCreator = this.getUrlCreator(options);\n\n    const config = getConfig(this.projectRoot, { skipSDKVersionRequirement: true });\n    const { exp } = config;\n    const useServerRendering = ['static', 'server'].includes(exp.web?.output ?? '');\n    const baseUrl = getBaseUrlFromExpoConfig(exp);\n    const asyncRoutes = getAsyncRoutesFromExpoConfig(exp, options.mode ?? 'development', 'web');\n    const routerRoot = getRouterDirectoryModuleIdWithManifest(this.projectRoot, exp);\n    const reactCompiler = !!exp.experiments?.reactCompiler;\n    const appDir = path.join(this.projectRoot, routerRoot);\n    const mode = options.mode ?? 'development';\n\n    this.instanceMetroOptions = {\n      isExporting: !!options.isExporting,\n      baseUrl,\n      mode,\n      routerRoot,\n      reactCompiler,\n      minify: options.minify,\n      asyncRoutes,\n      // Options that are changing between platforms like engine, platform, and environment aren't set here.\n    };\n\n    const parsedOptions = {\n      port: options.port,\n      maxWorkers: options.maxWorkers,\n      resetCache: options.resetDevServer,\n    };\n\n    // Required for symbolication:\n    process.env.EXPO_DEV_SERVER_ORIGIN = `http://localhost:${options.port}`;\n\n    const { metro, server, middleware, messageSocket } = await instantiateMetroAsync(\n      this,\n      parsedOptions,\n      {\n        isExporting: !!options.isExporting,\n        exp,\n      }\n    );\n\n    if (!options.isExporting) {\n      const manifestMiddleware = await this.getManifestMiddlewareAsync(options);\n\n      // Important that we noop source maps for context modules as soon as possible.\n      prependMiddleware(middleware, new ContextModuleSourceMapsMiddleware().getHandler());\n\n      // We need the manifest handler to be the first middleware to run so our\n      // routes take precedence over static files. For example, the manifest is\n      // served from '/' and if the user has an index.html file in their project\n      // then the manifest handler will never run, the static middleware will run\n      // and serve index.html instead of the manifest.\n      // https://github.com/expo/expo/issues/13114\n      prependMiddleware(middleware, manifestMiddleware.getHandler());\n\n      middleware.use(\n        new InterstitialPageMiddleware(this.projectRoot, {\n          // TODO: Prevent this from becoming stale.\n          scheme: options.location.scheme ?? null,\n        }).getHandler()\n      );\n      middleware.use(new ReactDevToolsPageMiddleware(this.projectRoot).getHandler());\n      middleware.use(\n        new DevToolsPluginMiddleware(this.projectRoot, this.devToolsPluginManager).getHandler()\n      );\n\n      const deepLinkMiddleware = new RuntimeRedirectMiddleware(this.projectRoot, {\n        onDeepLink: getDeepLinkHandler(this.projectRoot),\n        getLocation: ({ runtime }) => {\n          if (runtime === 'custom') {\n            return this.urlCreator?.constructDevClientUrl();\n          } else {\n            return this.urlCreator?.constructUrl({\n              scheme: 'exp',\n            });\n          }\n        },\n      });\n      middleware.use(deepLinkMiddleware.getHandler());\n\n      middleware.use(new CreateFileMiddleware(this.projectRoot).getHandler());\n\n      // Append support for redirecting unhandled requests to the index.html page on web.\n      if (this.isTargetingWeb()) {\n        // This MUST be after the manifest middleware so it doesn't have a chance to serve the template `public/index.html`.\n        middleware.use(new ServeStaticMiddleware(this.projectRoot).getHandler());\n\n        // This should come after the static middleware so it doesn't serve the favicon from `public/favicon.ico`.\n        middleware.use(new FaviconMiddleware(this.projectRoot).getHandler());\n\n        if (useServerRendering) {\n          middleware.use(\n            createRouteHandlerMiddleware(this.projectRoot, {\n              appDir,\n              routerRoot,\n              config,\n              ...config.exp.extra?.router,\n              bundleApiRoute: (functionFilePath) => this.ssrImportApiRoute(functionFilePath),\n              getStaticPageAsync: (pathname) => {\n                return this.getStaticPageAsync(pathname);\n              },\n            })\n          );\n\n          observeAnyFileChanges(\n            {\n              metro,\n              server,\n            },\n            (events) => {\n              if (exp.web?.output === 'server') {\n                // NOTE(EvanBacon): We aren't sure what files the API routes are using so we'll just invalidate\n                // aggressively to ensure we always have the latest. The only caching we really get here is for\n                // cases where the user is making subsequent requests to the same API route without changing anything.\n                // This is useful for testing but pretty suboptimal. Luckily our caching is pretty aggressive so it makes\n                // up for a lot of the overhead.\n                this.invalidateApiRouteCache();\n              } else if (!hasWarnedAboutApiRoutes()) {\n                for (const event of events) {\n                  if (\n                    // If the user did not delete a file that matches the Expo Router API Route convention, then we should warn that\n                    // API Routes are not enabled in the project.\n                    event.metadata?.type !== 'd' &&\n                    // Ensure the file is in the project's routes directory to prevent false positives in monorepos.\n                    event.filePath.startsWith(appDir) &&\n                    isApiRouteConvention(event.filePath)\n                  ) {\n                    warnInvalidWebOutput();\n                  }\n                }\n              }\n            }\n          );\n        } else {\n          // This MUST run last since it's the fallback.\n          middleware.use(\n            new HistoryFallbackMiddleware(manifestMiddleware.getHandler().internal).getHandler()\n          );\n        }\n      }\n    }\n    // Extend the close method to ensure that we clean up the local info.\n    const originalClose = server.close.bind(server);\n\n    server.close = (callback?: (err?: Error) => void) => {\n      return originalClose((err?: Error) => {\n        this.instance = null;\n        this.metro = null;\n        callback?.(err);\n      });\n    };\n\n    assertMetroPrivateServer(metro);\n    this.metro = metro;\n    return {\n      server,\n      location: {\n        // The port is the main thing we want to send back.\n        port: options.port,\n        // localhost isn't always correct.\n        host: 'localhost',\n        // http is the only supported protocol on native.\n        url: `http://localhost:${options.port}`,\n        protocol: 'http',\n      },\n      middleware,\n      messageSocket,\n    };\n  }\n\n  public async waitForTypeScriptAsync(): Promise<boolean> {\n    if (!this.instance) {\n      throw new Error('Cannot wait for TypeScript without a running server.');\n    }\n\n    return new Promise<boolean>((resolve) => {\n      if (!this.metro) {\n        // This can happen when the run command is used and the server is already running in another\n        // process. In this case we can't wait for the TypeScript check to complete because we don't\n        // have access to the Metro server.\n        debug('Skipping TypeScript check because Metro is not running (headless).');\n        return resolve(false);\n      }\n\n      const off = metroWatchTypeScriptFiles({\n        projectRoot: this.projectRoot,\n        server: this.instance!.server,\n        metro: this.metro,\n        tsconfig: true,\n        throttle: true,\n        eventTypes: ['change', 'add'],\n        callback: async () => {\n          // Run once, this prevents the TypeScript project prerequisite from running on every file change.\n          off();\n          const { TypeScriptProjectPrerequisite } = await import(\n            '../../doctor/typescript/TypeScriptProjectPrerequisite.js'\n          );\n\n          try {\n            const req = new TypeScriptProjectPrerequisite(this.projectRoot);\n            await req.bootstrapAsync();\n            resolve(true);\n          } catch (error: any) {\n            // Ensure the process doesn't fail if the TypeScript check fails.\n            // This could happen during the install.\n            Log.log();\n            Log.error(\n              chalk.red`Failed to automatically setup TypeScript for your project. Try restarting the dev server to fix.`\n            );\n            Log.exception(error);\n            resolve(false);\n          }\n        },\n      });\n    });\n  }\n\n  public async startTypeScriptServices() {\n    return startTypescriptTypeGenerationAsync({\n      server: this.instance?.server,\n      metro: this.metro,\n      projectRoot: this.projectRoot,\n    });\n  }\n\n  protected getConfigModuleIds(): string[] {\n    return ['./metro.config.js', './metro.config.json', './rn-cli.config.js'];\n  }\n\n  private pendingRouteOperations = new Map<\n    string,\n    Promise<{ src: string; filename: string; map: string } | null>\n  >();\n\n  // API Routes\n\n  // Bundle the API Route with Metro and return the string contents to be evaluated in the server.\n  private async bundleApiRoute(\n    filePath: string\n  ): Promise<{ src: string; filename: string; map: string } | null | undefined> {\n    if (this.pendingRouteOperations.has(filePath)) {\n      return this.pendingRouteOperations.get(filePath);\n    }\n    const bundleAsync = async () => {\n      try {\n        debug('Bundle API route:', this.instanceMetroOptions.routerRoot, filePath);\n        return await this.ssrLoadModuleContents(filePath);\n      } catch (error: any) {\n        const appDir = this.instanceMetroOptions?.routerRoot\n          ? path.join(this.projectRoot, this.instanceMetroOptions!.routerRoot!)\n          : undefined;\n        const relativePath = appDir ? path.relative(appDir, filePath) : filePath;\n\n        // Expected errors: invalid syntax, missing resolutions.\n        // Wrap with command error for better error messages.\n        const err = new CommandError(\n          'API_ROUTE',\n          chalk`Failed to bundle API Route: {bold ${relativePath}}\\n\\n` + error.message\n        );\n\n        for (const key in error) {\n          // @ts-expect-error\n          err[key] = error[key];\n        }\n\n        throw err;\n      } finally {\n        // pendingRouteOperations.delete(filepath);\n      }\n    };\n    const route = bundleAsync();\n\n    this.pendingRouteOperations.set(filePath, route);\n    return route;\n  }\n\n  private async ssrImportApiRoute(\n    filePath: string\n  ): Promise<null | Record<string, Function> | Response> {\n    // TODO: Cache the evaluated function.\n    try {\n      const apiRoute = await this.bundleApiRoute(filePath);\n\n      if (!apiRoute?.src) {\n        return null;\n      }\n      return evalMetroNoHandling(this.projectRoot, apiRoute.src, apiRoute.filename);\n    } catch (error) {\n      // Format any errors that were thrown in the global scope of the evaluation.\n      if (error instanceof Error) {\n        try {\n          const htmlServerError = await getErrorOverlayHtmlAsync({\n            error,\n            projectRoot: this.projectRoot,\n            routerRoot: this.instanceMetroOptions.routerRoot!,\n          });\n\n          return new Response(htmlServerError, {\n            status: 500,\n            headers: {\n              'Content-Type': 'text/html',\n            },\n          });\n        } catch (internalError) {\n          debug('Failed to generate Metro server error UI for API Route error:', internalError);\n          throw error;\n        }\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  private invalidateApiRouteCache() {\n    this.pendingRouteOperations.clear();\n  }\n\n  // Direct Metro access\n\n  // Emulates the Metro dev server .bundle endpoint without having to go through a server.\n  private async _bundleDirectAsync(\n    resolvedEntryFilePath: string,\n    {\n      transformOptions,\n      resolverOptions,\n      graphOptions,\n      serializerOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      serializerOptions: {\n        modulesOnly: boolean;\n        runModule: boolean;\n        sourceMapUrl: string;\n        sourceUrl: string;\n        inlineSourceMap: boolean;\n        excludeSource: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ): Promise<{\n    numModifiedFiles: number;\n    lastModifiedDate: Date;\n    nextRevId: string;\n    bundle: string;\n    map: string;\n\n    // Defined if the output is multi-bundle.\n    artifacts?: SerialAsset[];\n    assets?: readonly BundleAssetWithFileHashes[];\n  }> {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n    const buildNumber = this.metro.getNewBuildNumber();\n    const bundlePerfLogger = config.unstable_perfLoggerFactory?.('BUNDLING_REQUEST', {\n      key: buildNumber,\n    });\n\n    const onProgress: MetroOnProgress = (transformedFileCount: number, totalFileCount: number) => {\n      this.metro?._reporter?.update?.({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_transform_progressed',\n        transformedFileCount,\n        totalFileCount,\n      });\n    };\n\n    const revPromise = this.getMetroRevision(resolvedEntryFilePath, {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    });\n\n    bundlePerfLogger?.point('resolvingAndTransformingDependencies_start');\n    bundlePerfLogger?.annotate({\n      bool: {\n        initial_build: revPromise == null,\n      },\n    });\n    this.metro?._reporter.update({\n      buildID: getBuildID(buildNumber),\n      bundleDetails: {\n        bundleType: transformOptions.type,\n        dev: transformOptions.dev,\n        entryFile: resolvedEntryFilePath,\n        minify: transformOptions.minify,\n        platform: transformOptions.platform,\n        // @ts-expect-error: typed incorrectly upstream\n        customResolverOptions: resolverOptions.customResolverOptions,\n        customTransformOptions: transformOptions.customTransformOptions,\n      },\n      isPrefetch: false,\n      type: 'bundle_build_started',\n    });\n\n    try {\n      const { delta, revision } = await (revPromise != null\n        ? this.metro.getBundler().updateGraph(await revPromise, false)\n        : this.metro.getBundler().initializeGraph(\n            // NOTE: Using absolute path instead of relative input path is a breaking change.\n            // entryFile,\n            resolvedEntryFilePath,\n\n            transformOptions,\n            resolverOptions,\n            {\n              onProgress,\n              shallow: graphOptions.shallow,\n              // @ts-expect-error: typed incorrectly\n              lazy: graphOptions.lazy,\n            }\n          ));\n      bundlePerfLogger?.annotate({\n        int: {\n          graph_node_count: revision.graph.dependencies.size,\n        },\n      });\n      bundlePerfLogger?.point('resolvingAndTransformingDependencies_end');\n      bundlePerfLogger?.point('serializingBundle_start');\n\n      const shouldAddToIgnoreList = this.metro._shouldAddModuleToIgnoreList.bind(this.metro);\n\n      const serializer = this.getMetroSerializer();\n\n      const bundle = await serializer(\n        // NOTE: Using absolute path instead of relative input path is a breaking change.\n        // entryFile,\n        resolvedEntryFilePath,\n\n        revision.prepend as any,\n        revision.graph as any,\n        {\n          asyncRequireModulePath: await this.metro._resolveRelativePath(\n            config.transformer.asyncRequireModulePath,\n            {\n              relativeTo: 'project',\n              resolverOptions,\n              transformOptions,\n            }\n          ),\n          // ...serializerOptions,\n          processModuleFilter: config.serializer.processModuleFilter,\n          createModuleId: this.metro._createModuleId,\n          getRunModuleStatement: config.serializer.getRunModuleStatement,\n          includeAsyncPaths: graphOptions.lazy,\n          dev: transformOptions.dev,\n          projectRoot: config.projectRoot,\n          modulesOnly: serializerOptions.modulesOnly,\n          runBeforeMainModule: config.serializer.getModulesRunBeforeMainModule(\n            resolvedEntryFilePath\n            // path.relative(config.projectRoot, entryFile)\n          ),\n          runModule: serializerOptions.runModule,\n          sourceMapUrl: serializerOptions.sourceMapUrl,\n          sourceUrl: serializerOptions.sourceUrl,\n          inlineSourceMap: serializerOptions.inlineSourceMap,\n          serverRoot: config.server.unstable_serverRoot ?? config.projectRoot,\n          shouldAddToIgnoreList,\n\n          // @ts-expect-error: passed to our serializer to enable non-serial return values.\n          serializerOptions,\n        }\n      );\n\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_done',\n      });\n\n      bundlePerfLogger?.point('serializingBundle_end');\n\n      let bundleCode: string | null = null;\n      let bundleMap: string | null = null;\n\n      // @ts-expect-error: If the output is multi-bundle...\n      if (serializerOptions.output === 'static') {\n        try {\n          const parsed = typeof bundle === 'string' ? JSON.parse(bundle) : bundle;\n\n          assert(\n            'artifacts' in parsed && Array.isArray(parsed.artifacts),\n            'Expected serializer to return an object with key artifacts to contain an array of serial assets.'\n          );\n\n          const artifacts = parsed.artifacts as SerialAsset[];\n          const assets = parsed.assets;\n\n          const bundleCode = artifacts.filter((asset) => asset.type === 'js')[0];\n          const bundleMap = artifacts.filter((asset) => asset.type === 'map')?.[0]?.source ?? '';\n\n          return {\n            numModifiedFiles: delta.reset\n              ? delta.added.size + revision.prepend.length\n              : delta.added.size + delta.modified.size + delta.deleted.size,\n            lastModifiedDate: revision.date,\n            nextRevId: revision.id,\n            bundle: bundleCode.source,\n            map: bundleMap,\n            artifacts,\n            assets,\n          };\n        } catch (error: any) {\n          throw new Error(\n            'Serializer did not return expected format. The project copy of `expo/metro-config` may be out of date. Error: ' +\n              error.message\n          );\n        }\n      }\n\n      if (typeof bundle === 'string') {\n        bundleCode = bundle;\n\n        // Create the source map in a second pass...\n        let { prepend, graph } = revision;\n        if (serializerOptions.modulesOnly) {\n          prepend = [];\n        }\n\n        bundleMap = await sourceMapStringAsync(\n          [\n            //\n            ...prepend,\n            ...this.metro._getSortedModules(graph),\n          ],\n          {\n            excludeSource: serializerOptions.excludeSource,\n            processModuleFilter: config.serializer.processModuleFilter,\n            shouldAddToIgnoreList,\n          }\n        );\n      } else {\n        bundleCode = bundle.code;\n        bundleMap = bundle.map;\n      }\n\n      return {\n        numModifiedFiles: delta.reset\n          ? delta.added.size + revision.prepend.length\n          : delta.added.size + delta.modified.size + delta.deleted.size,\n        lastModifiedDate: revision.date,\n        nextRevId: revision.id,\n        bundle: bundleCode,\n        map: bundleMap,\n      };\n    } catch (error) {\n      this.metro._reporter.update({\n        buildID: getBuildID(buildNumber),\n        type: 'bundle_build_failed',\n      });\n\n      throw error;\n    }\n  }\n\n  private getMetroSerializer() {\n    return (\n      this.metro?._config?.serializer.customSerializer ||\n      ((entryPoint, preModules, graph, options) =>\n        bundleToString(baseJSBundle(entryPoint, preModules, graph, options)).code)\n    );\n  }\n\n  private getMetroRevision(\n    resolvedEntryFilePath: string,\n    {\n      graphOptions,\n      transformOptions,\n      resolverOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n      graphOptions: {\n        shallow: boolean;\n        lazy: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'Metro server must be running to bundle directly.');\n    const config = this.metro._config;\n\n    const graphId = getGraphId(resolvedEntryFilePath, transformOptions, {\n      unstable_allowRequireContext: config.transformer.unstable_allowRequireContext,\n      resolverOptions,\n      shallow: graphOptions.shallow,\n      lazy: graphOptions.lazy,\n    });\n    return this.metro.getBundler().getRevisionByGraphId(graphId);\n  }\n\n  private async resolveRelativePathAsync(\n    moduleId: string,\n    {\n      resolverOptions,\n      transformOptions,\n    }: {\n      transformOptions: TransformInputOptions;\n      resolverOptions: {\n        customResolverOptions: CustomResolverOptions;\n        dev: boolean;\n      };\n    }\n  ) {\n    assert(this.metro, 'cannot invoke resolveRelativePathAsync without metro instance');\n    return await this.metro._resolveRelativePath(convertPathToModuleSpecifier(moduleId), {\n      relativeTo: 'server',\n      resolverOptions,\n      transformOptions,\n    });\n  }\n}\n\nfunction getBuildID(buildNumber: number): string {\n  return buildNumber.toString(36);\n}\n\nexport function getDeepLinkHandler(projectRoot: string): DeepLinkHandler {\n  return async ({ runtime }) => {\n    if (runtime === 'expo') return;\n    const { exp } = getConfig(projectRoot);\n    await logEventAsync('dev client start command', {\n      status: 'started',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n  };\n}\n\nfunction wrapBundle(str: string) {\n  // Skip the metro runtime so debugging is a bit easier.\n  // Replace the __r() call with an export statement.\n  // Use gm to apply to the last require line. This is needed when the bundle has side-effects.\n  return str.replace(/^(__r\\(.*\\);)$/gm, 'module.exports = $1');\n}\n\nasync function sourceMapStringAsync(\n  modules: readonly import('metro/src/DeltaBundler/types').Module<any>[],\n  options: SourceMapGeneratorOptions\n): Promise<string> {\n  return (await sourceMapGeneratorNonBlocking(modules, options)).toString(undefined, {\n    excludeSource: options.excludeSource,\n  });\n}\n"],"names":["MetroBundlerDevServer","getDeepLinkHandler","debug","require","getGraphId","EXPO_GO_METRO_PORT","DEV_CLIENT_METRO_PORT","BundlerDevServer","metro","name","resolvePortAsync","options","port","devClient","Number","process","env","RCT_METRO_PORT","getFreePortAsync","exportExpoRouterApiRoutesAsync","includeSourceMaps","outputDir","prerenderManifest","routerRoot","instanceMetroOptions","assert","appDir","path","join","projectRoot","manifest","getExpoRouterRoutesManifestAsync","files","Map","route","apiRoutes","filepath","file","contents","bundleApiRoute","artifactFilename","relative","replace","src","map","artifactBasename","encodeURIComponent","basename","parsedMap","JSON","parse","set","stringify","version","sources","source","startsWith","convertPathToModuleSpecifier","sourcesContent","Array","length","fill","names","mappings","targetDomain","htmlRoutes","exp","getConfig","fetchManifest","extra","router","platformRoutes","asJson","CommandError","getStaticRenderFunctionAsync","url","getDevServerUrl","getStaticContent","getManifest","getBuildTimeServerManifestAsync","ssrLoadModule","serverManifest","preserveApiRoutes","renderAsync","URL","getStaticResourcesAsync","mainModuleName","mode","minify","isExporting","baseUrl","reactCompiler","asyncRoutes","platform","resolvedMainModuleName","resolveMainModuleName","metroImportAsArtifactsAsync","splitChunks","EXPO_NO_BUNDLE_SPLITTING","environment","serializerIncludeMaps","lazy","shouldEnableAsyncImports","bytecode","getStaticPageAsync","pathname","devBundleUrlPathname","createBundleUrlPath","bundleStaticHtml","location","artifacts","resources","staticHtml","Promise","all","content","serializeHtmlWithAssets","template","devBundleUrl","filePath","specificOptions","res","ssrLoadModuleContents","evalMetroAndWrapFunctions","filename","results","serializerOutput","assets","metroLoadModuleContents","extraOptions","opts","inlineSourceMap","engine","expoBundleOptions","getMetroDirectBundleOptions","resolverOptions","customResolverOptions","dev","transformOptions","hot","type","unstable_transformProfile","customTransformOptions","Object","create","runtimeBytecodeVersion","resolvedEntryFilePath","resolveRelativePathAsync","_bundleDirectAsync","graphOptions","shallow","serializerOptions","modulesOnly","runModule","sourceUrl","sourceMapUrl","bundle","rest","scriptContents","wrapBundle","cachedSourceMaps","legacySinglePageExportBundleAsync","output","watchEnvironmentVariables","instance","Error","envFiles","runtimeEnv","getFiles","NODE_ENV","fileName","observeFileChanges","server","load","force","startImplementationAsync","urlCreator","getUrlCreator","config","skipSDKVersionRequirement","useServerRendering","includes","web","getBaseUrlFromExpoConfig","getAsyncRoutesFromExpoConfig","getRouterDirectoryModuleIdWithManifest","experiments","parsedOptions","maxWorkers","resetCache","resetDevServer","EXPO_DEV_SERVER_ORIGIN","middleware","messageSocket","instantiateMetroAsync","manifestMiddleware","getManifestMiddlewareAsync","prependMiddleware","ContextModuleSourceMapsMiddleware","getHandler","use","InterstitialPageMiddleware","scheme","ReactDevToolsPageMiddleware","DevToolsPluginMiddleware","devToolsPluginManager","deepLinkMiddleware","RuntimeRedirectMiddleware","onDeepLink","getLocation","runtime","constructDevClientUrl","constructUrl","CreateFileMiddleware","isTargetingWeb","ServeStaticMiddleware","FaviconMiddleware","createRouteHandlerMiddleware","functionFilePath","ssrImportApiRoute","observeAnyFileChanges","events","invalidateApiRouteCache","hasWarnedAboutApiRoutes","event","metadata","isApiRouteConvention","warnInvalidWebOutput","HistoryFallbackMiddleware","internal","originalClose","close","bind","callback","err","assertMetroPrivateServer","host","protocol","waitForTypeScriptAsync","resolve","off","metroWatchTypeScriptFiles","tsconfig","throttle","eventTypes","TypeScriptProjectPrerequisite","req","bootstrapAsync","error","Log","log","chalk","red","exception","startTypeScriptServices","startTypescriptTypeGenerationAsync","getConfigModuleIds","pendingRouteOperations","has","get","bundleAsync","undefined","relativePath","message","key","apiRoute","evalMetroNoHandling","htmlServerError","getErrorOverlayHtmlAsync","Response","status","headers","internalError","clear","_config","buildNumber","getNewBuildNumber","bundlePerfLogger","unstable_perfLoggerFactory","onProgress","transformedFileCount","totalFileCount","_reporter","update","buildID","getBuildID","revPromise","getMetroRevision","point","annotate","bool","initial_build","bundleDetails","bundleType","entryFile","isPrefetch","delta","revision","getBundler","updateGraph","initializeGraph","int","graph_node_count","graph","dependencies","size","shouldAddToIgnoreList","_shouldAddModuleToIgnoreList","serializer","getMetroSerializer","prepend","asyncRequireModulePath","_resolveRelativePath","transformer","relativeTo","processModuleFilter","createModuleId","_createModuleId","getRunModuleStatement","includeAsyncPaths","runBeforeMainModule","getModulesRunBeforeMainModule","serverRoot","unstable_serverRoot","bundleCode","bundleMap","parsed","isArray","filter","asset","numModifiedFiles","reset","added","modified","deleted","lastModifiedDate","date","nextRevId","id","sourceMapStringAsync","_getSortedModules","excludeSource","code","customSerializer","entryPoint","preModules","bundleToString","baseJSBundle","graphId","unstable_allowRequireContext","getRevisionByGraphId","moduleId","toString","logEventAsync","getDevClientProperties","str","modules","sourceMapGeneratorNonBlocking"],"mappings":"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"}
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
