"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
<<<<<<< HEAD
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    _getSchemaAsync: function() {
        return _getSchemaAsync;
    },
    getAssetSchemasAsync: function() {
        return getAssetSchemasAsync;
    }
});
function _fs() {
    const data = /*#__PURE__*/ _interop_require_default(require("fs"));
=======
Object.defineProperty(exports, "getAssetSchemasAsync", {
    enumerable: true,
    get: ()=>getAssetSchemasAsync
});
function _fs() {
    const data = /*#__PURE__*/ _interopRequireDefault(require("fs"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _fs = function() {
        return data;
    };
    return data;
}
<<<<<<< HEAD
function _path() {
    const data = /*#__PURE__*/ _interop_require_default(require("path"));
=======
function _jsonSchemaDerefSync() {
    const data = /*#__PURE__*/ _interopRequireDefault(require("json-schema-deref-sync"));
    _jsonSchemaDerefSync = function() {
        return data;
    };
    return data;
}
function _path() {
    const data = /*#__PURE__*/ _interopRequireDefault(require("path"));
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    _path = function() {
        return data;
    };
    return data;
}
const _client = require("./rest/client");
const _env = require("../utils/env");
const _errors = require("../utils/errors");
<<<<<<< HEAD
const _jsonSchemaDeref = require("../utils/jsonSchemaDeref");
function _interop_require_default(obj) {
=======
function _interopRequireDefault(obj) {
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const schemaJson = {};
<<<<<<< HEAD
async function _getSchemaAsync(sdkVersion) {
    const json = await getSchemaJSONAsync(sdkVersion);
    // NOTE(@kitten): This is a replacement for the `json-schema-deref-sync` package.
    // We re-implemented it locally to remove it, since it comes with heavy dependencies
    // and a large install time impact.
    // The tests have been ported to match the behaviour closely, but we removed
    // local file ref support. For our purposes the behaviour should be identical.
    return (0, _jsonSchemaDeref.jsonSchemaDeref)(json.schema);
}
async function getAssetSchemasAsync(sdkVersion = 'UNVERSIONED') {
    // If no SDK version is available then fall back to unversioned
    const schema = await _getSchemaAsync(sdkVersion);
=======
// TODO: Maybe move json-schema-deref-sync out of api (1.58MB -- lodash)
// https://packagephobia.com/result?p=json-schema-deref-sync
async function getSchemaAsync(sdkVersion) {
    const json = await getSchemaJSONAsync(sdkVersion);
    return (0, _jsonSchemaDerefSync().default)(json.schema);
}
async function getAssetSchemasAsync(sdkVersion = "UNVERSIONED") {
    // If no SDK version is available then fall back to unversioned
    const schema = await getSchemaAsync(sdkVersion);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    const assetSchemas = [];
    const visit = (node, fieldPath)=>{
        if (node.meta && node.meta.asset) {
            assetSchemas.push(fieldPath);
        }
        const properties = node.properties;
        if (properties) {
<<<<<<< HEAD
            Object.keys(properties).forEach((property)=>visit(properties[property], `${fieldPath}${fieldPath.length > 0 ? '.' : ''}${property}`));
        }
    };
    visit(schema, '');
=======
            Object.keys(properties).forEach((property)=>visit(properties[property], `${fieldPath}${fieldPath.length > 0 ? "." : ""}${property}`));
        }
    };
    visit(schema, "");
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    return assetSchemas;
}
async function getSchemaJSONAsync(sdkVersion) {
    if (_env.env.EXPO_UNIVERSE_DIR) {
<<<<<<< HEAD
        return JSON.parse(_fs().default.readFileSync(_path().default.join(_env.env.EXPO_UNIVERSE_DIR, 'server', 'www', 'xdl-schemas', 'UNVERSIONED-schema.json')).toString());
=======
        return JSON.parse(_fs().default.readFileSync(_path().default.join(_env.env.EXPO_UNIVERSE_DIR, "server", "www", "xdl-schemas", "UNVERSIONED-schema.json")).toString());
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
    }
    if (!schemaJson[sdkVersion]) {
        try {
            schemaJson[sdkVersion] = await getConfigurationSchemaAsync(sdkVersion);
        } catch (e) {
<<<<<<< HEAD
            if (e.code === 'INVALID_JSON') {
                throw new _errors.CommandError('INVALID_JSON', `Couldn't read schema from server`);
=======
            if (e.code === "INVALID_JSON") {
                throw new _errors.CommandError("INVALID_JSON", `Couldn't read schema from server`);
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
            }
            throw e;
        }
    }
    return schemaJson[sdkVersion];
}
async function getConfigurationSchemaAsync(sdkVersion) {
    // Reconstruct the cached fetch since caching could be disabled.
    const fetchAsync = (0, _client.createCachedFetch)({
<<<<<<< HEAD
        cacheDirectory: 'schema-cache',
=======
        cacheDirectory: "schema-cache",
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
        // We'll use a 1 week cache for versions so older versions get flushed out eventually.
        ttl: 1000 * 60 * 60 * 24 * 7
    });
    const response = await fetchAsync(`project/configuration/schema/${sdkVersion}`);
<<<<<<< HEAD
    const json = await response.json();
    return (0, _client.getResponseDataOrThrow)(json);
=======
    const { data  } = await response.json();
    return data;
>>>>>>> 0823204efb84884a0322b43e865bb36631ba8251
}

//# sourceMappingURL=getExpoSchema.js.map